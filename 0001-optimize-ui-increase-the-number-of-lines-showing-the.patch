From ef819c61535097842a6447c1e46fc76100daa0f0 Mon Sep 17 00:00:00 2001
From: lzl <2233788867@qq.com>
Date: Tue, 7 Jan 2025 07:01:44 +0800
Subject: [PATCH] optimize (ui): increase the number of lines showing the
 searched video names to 2

---
 app/build.gradle                              |   2 -
 .../main/java/com/liuzhenlin/videos/App.java  |   7 +-
 .../com/liuzhenlin/videos/dao/AppPrefs.java   |   7 +-
 .../com/liuzhenlin/videos/model/BaseModel.kt  |   4 +-
 .../videos/model/BaseRepository.java          |  12 +-
 .../videos/model/FeedbackRepository.java      |   9 +-
 .../videos/model/FeedbackRepositoryImpl.java  | 105 +++++++------
 .../model/LocalSearchedVideoListModel.kt      |  16 +-
 .../videos/model/LocalVideoListModel.kt       |  18 ++-
 .../videos/model/OnlineVideoListModel.kt      |   3 +-
 .../videos/model/VideoMoveRepository.kt       |  18 ++-
 .../videos/model/VideoRepository.java         |   8 +-
 .../videos/model/VideoRepositoryImpl.java     | 144 ++++++++++--------
 .../videos/presenter/FeedbackPresenter.java   |  19 ++-
 .../videos/presenter/IFeedbackPresenter.java  |   5 +-
 .../videos/presenter/IVideoPresenter.java     |   5 +-
 .../presenter/LocalSearchedVideosPresenter.kt |  14 +-
 .../presenter/LocalVideoListPresenter.kt      |  25 +--
 .../videos/presenter/Presenter.java           |  38 ++++-
 .../videos/presenter/VideoMovePresenter.kt    |   8 +-
 .../videos/presenter/VideoPresenter.java      |  38 +++--
 .../view/activity/FeedbackActivity.java       |   4 +-
 .../videos/view/activity/MainActivity.java    |  47 ++++--
 .../videos/view/activity/VideoActivity.java   | 122 ++++++++-------
 .../activity/startup/LaunchProcessor.java     |   7 +-
 .../fragment/LocalSearchedVideosFragment.kt   |  62 ++++----
 .../view/fragment/LocalVideoListFragment.kt   |  75 ++++-----
 .../view/fragment/LocalVideosFragment.kt      |  39 ++---
 .../videos/view/fragment/VideoMoveFragment.kt |  30 ++--
 common_build.gradle                           |   2 +
 .../LifecycleCoroutineScopeImplAccessor.java  |  24 +++
 .../androidx/lifecycle/ViewModelAccessor.java |  25 +++
 .../common/utils/CloseableCoroutineScope.kt   |  20 +++
 .../com/liuzhenlin/common/utils/Coroutines.kt |  78 ++++++++++
 .../liuzhenlin/common/utils/JCoroutine.java   | 127 +++++++++++++++
 .../com/liuzhenlin/common/utils/JavaOnly.java |  22 +++
 .../common/utils/ReflectionUtils.java         |  14 ++
 37 files changed, 856 insertions(+), 347 deletions(-)
 create mode 100644 libraries/common/src/main/java/androidx/lifecycle/LifecycleCoroutineScopeImplAccessor.java
 create mode 100644 libraries/common/src/main/java/androidx/lifecycle/ViewModelAccessor.java
 create mode 100644 libraries/common/src/main/java/com/liuzhenlin/common/utils/CloseableCoroutineScope.kt
 create mode 100644 libraries/common/src/main/java/com/liuzhenlin/common/utils/Coroutines.kt
 create mode 100644 libraries/common/src/main/java/com/liuzhenlin/common/utils/JCoroutine.java
 create mode 100644 libraries/common/src/main/java/com/liuzhenlin/common/utils/JavaOnly.java

diff --git a/app/build.gradle b/app/build.gradle
index eff18ff..73d0ce6 100644
--- a/app/build.gradle
+++ b/app/build.gradle
@@ -1,5 +1,4 @@
 apply plugin: 'com.android.application'
-apply plugin: 'kotlin-android'
 
 apply from: "$rootDir/common_build.gradle"
 
@@ -41,7 +40,6 @@ android {
 }
 
 dependencies {
-    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8:$kotlin_version"
     implementation 'androidx.multidex:multidex:2.0.1'
     implementation 'androidx.core:core-splashscreen:1.0.1'
 
diff --git a/app/src/main/java/com/liuzhenlin/videos/App.java b/app/src/main/java/com/liuzhenlin/videos/App.java
index ddf8fc8..5164f94 100644
--- a/app/src/main/java/com/liuzhenlin/videos/App.java
+++ b/app/src/main/java/com/liuzhenlin/videos/App.java
@@ -23,9 +23,10 @@ import com.bumptech.glide.Glide;
 import com.liuzhenlin.common.Configs;
 import com.liuzhenlin.common.compat.ApplicationCompat;
 import com.liuzhenlin.common.listener.OnSystemUiNightModeChangedListener;
+import com.liuzhenlin.common.utils.AppScope;
 import com.liuzhenlin.common.utils.DensityUtils;
-import com.liuzhenlin.common.utils.Executors;
 import com.liuzhenlin.common.utils.InternetResourceLoadTask;
+import com.liuzhenlin.common.utils.JCoroutine;
 import com.liuzhenlin.common.utils.LanguageUtils;
 import com.liuzhenlin.common.utils.ListenerSet;
 import com.liuzhenlin.common.utils.ThemeUtils;
@@ -37,6 +38,7 @@ import com.liuzhenlin.videos.web.youtube.YoutubePlaybackService;
 
 import java.util.Locale;
 
+import kotlinx.coroutines.Dispatchers;
 import pub.devrel.easypermissions.EasyPermissions;
 
 /**
@@ -71,7 +73,8 @@ public class App extends Application {
         super.onCreate();
         sApp = this;
 
-        Executors.THREAD_POOL_EXECUTOR.execute(new CrashMailReporter(this)::send);
+        JCoroutine.launch(AppScope.INSTANCE, Dispatchers.getIO(),
+                new CrashMailReporter(this)::send);
         Thread.setDefaultUncaughtExceptionHandler(LogOnCrashHandler.INSTANCE.get(this));
 
         mSystemUiNightMode = ThemeUtils.isNightMode(this);
diff --git a/app/src/main/java/com/liuzhenlin/videos/dao/AppPrefs.java b/app/src/main/java/com/liuzhenlin/videos/dao/AppPrefs.java
index aec0f2f..a2b7d40 100644
--- a/app/src/main/java/com/liuzhenlin/videos/dao/AppPrefs.java
+++ b/app/src/main/java/com/liuzhenlin/videos/dao/AppPrefs.java
@@ -20,8 +20,9 @@ import com.bumptech.glide.util.Synthetic;
 import com.liuzhenlin.common.Configs;
 import com.liuzhenlin.common.Consts;
 import com.liuzhenlin.common.utils.AESUtils;
-import com.liuzhenlin.common.utils.Executors;
+import com.liuzhenlin.common.utils.AppScope;
 import com.liuzhenlin.common.utils.IOUtils;
+import com.liuzhenlin.common.utils.JCoroutine;
 import com.liuzhenlin.common.utils.LanguageUtils;
 import com.liuzhenlin.common.utils.Singleton;
 import com.liuzhenlin.videos.App;
@@ -42,6 +43,8 @@ import java.util.concurrent.locks.Lock;
 import java.util.concurrent.locks.ReadWriteLock;
 import java.util.concurrent.locks.ReentrantReadWriteLock;
 
+import kotlinx.coroutines.Dispatchers;
+
 import static com.liuzhenlin.videos.Consts.SORT_MODE_NAME_ASC;
 
 /**
@@ -178,7 +181,7 @@ public final class AppPrefs {
                         if (TextUtils.isEmpty(guid)) {
                             guid = UUID.randomUUID().toString();
                             String finalGuid = guid;
-                            Executors.THREAD_POOL_EXECUTOR.execute(() -> {
+                            JCoroutine.launch(AppScope.INSTANCE, Dispatchers.getIO(), () -> {
                                 Writer writer = null;
                                 Exception ex = null;
                                 try {
diff --git a/app/src/main/java/com/liuzhenlin/videos/model/BaseModel.kt b/app/src/main/java/com/liuzhenlin/videos/model/BaseModel.kt
index 9da51e4..63522f7 100644
--- a/app/src/main/java/com/liuzhenlin/videos/model/BaseModel.kt
+++ b/app/src/main/java/com/liuzhenlin/videos/model/BaseModel.kt
@@ -8,11 +8,13 @@ package com.liuzhenlin.videos.model
 import android.annotation.SuppressLint
 import android.content.Context
 import android.os.AsyncTask
+import kotlinx.coroutines.CoroutineScope
 
 /**
  * @author 刘振林
  */
-abstract class BaseModel<Progress, Result, Callback : BaseModel.Callback>(context: Context) {
+abstract class BaseModel<Progress, Result, Callback : BaseModel.Callback>(
+        context: Context, protected val mCoroutineScope: CoroutineScope) {
 
     @Suppress("RemoveEmptyClassBody")
     interface Callback {
diff --git a/app/src/main/java/com/liuzhenlin/videos/model/BaseRepository.java b/app/src/main/java/com/liuzhenlin/videos/model/BaseRepository.java
index 3bc16b3..b406c24 100644
--- a/app/src/main/java/com/liuzhenlin/videos/model/BaseRepository.java
+++ b/app/src/main/java/com/liuzhenlin/videos/model/BaseRepository.java
@@ -10,15 +10,17 @@ import android.content.Context;
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
 
+import kotlinx.coroutines.CoroutineScope;
+
 public abstract class BaseRepository<C extends Repository.Callback> implements Repository<C> {
 
-    @NonNull
-    protected final Context mContext;
-    @Nullable
-    protected C mCallback;
+    @NonNull protected final CoroutineScope mCoroutineScope;
+    @NonNull protected final Context mContext;
+    @Nullable protected C mCallback;
 
-    public BaseRepository(@NonNull Context context) {
+    public BaseRepository(@NonNull Context context, @NonNull CoroutineScope coroutineScope) {
         mContext = context.getApplicationContext();
+        mCoroutineScope = coroutineScope;
     }
 
     @Override
diff --git a/app/src/main/java/com/liuzhenlin/videos/model/FeedbackRepository.java b/app/src/main/java/com/liuzhenlin/videos/model/FeedbackRepository.java
index 9783cd5..495f651 100644
--- a/app/src/main/java/com/liuzhenlin/videos/model/FeedbackRepository.java
+++ b/app/src/main/java/com/liuzhenlin/videos/model/FeedbackRepository.java
@@ -13,13 +13,16 @@ import androidx.annotation.Nullable;
 
 import java.util.List;
 
+import kotlinx.coroutines.CoroutineScope;
+
 public interface FeedbackRepository extends Repository<FeedbackRepository.Callback> {
 
     @NonNull
     static FeedbackRepository create(
-            @NonNull Context context, @NonNull UserFilledTextsFetcher userTextsFetcher,
-            int maxCountOfPicturesToUpload) {
-        return new FeedbackRepositoryImpl(context, userTextsFetcher, maxCountOfPicturesToUpload);
+            @NonNull Context context, @NonNull CoroutineScope coroutineScope,
+            @NonNull UserFilledTextsFetcher userTextsFetcher, int maxCountOfPicturesToUpload) {
+        return new FeedbackRepositoryImpl(
+                context, coroutineScope, userTextsFetcher, maxCountOfPicturesToUpload);
     }
 
     @NonNull List<Bitmap> getPictures();
diff --git a/app/src/main/java/com/liuzhenlin/videos/model/FeedbackRepositoryImpl.java b/app/src/main/java/com/liuzhenlin/videos/model/FeedbackRepositoryImpl.java
index 029a12d..05b8669 100644
--- a/app/src/main/java/com/liuzhenlin/videos/model/FeedbackRepositoryImpl.java
+++ b/app/src/main/java/com/liuzhenlin/videos/model/FeedbackRepositoryImpl.java
@@ -8,6 +8,7 @@ package com.liuzhenlin.videos.model;
 import android.content.Context;
 import android.graphics.Bitmap;
 import android.os.Bundle;
+import android.util.Log;
 
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
@@ -15,8 +16,7 @@ import androidx.appcompat.content.res.AppCompatResources;
 
 import com.liuzhenlin.common.Consts;
 import com.liuzhenlin.common.utils.BitmapUtils;
-import com.liuzhenlin.common.utils.Executors;
-import com.liuzhenlin.common.utils.Utils;
+import com.liuzhenlin.common.utils.JCoroutine;
 import com.liuzhenlin.videos.R;
 import com.liuzhenlin.videos.bean.FeedbackInfo;
 import com.liuzhenlin.videos.dao.FeedbackSavedPrefs;
@@ -27,13 +27,18 @@ import java.util.Arrays;
 import java.util.Iterator;
 import java.util.LinkedList;
 import java.util.List;
-import java.util.concurrent.atomic.AtomicBoolean;
+
+import kotlinx.coroutines.CoroutineScope;
+import kotlinx.coroutines.CoroutineScopeKt;
+import kotlinx.coroutines.Dispatchers;
 
 import static com.liuzhenlin.common.Consts.EMPTY_STRING;
 
 class FeedbackRepositoryImpl extends BaseRepository<FeedbackRepository.Callback>
         implements FeedbackRepository {
 
+    private static final String TAG = "FeedbackRepository";
+
     private final UserFilledTextsFetcher mUserFilledTextsFetcher;
     private final FeedbackSavedPrefs mFeedbackSPs;
     private final FeedbackInfo mSavedFeedbackInfo;
@@ -51,16 +56,24 @@ class FeedbackRepositoryImpl extends BaseRepository<FeedbackRepository.Callback>
     private static final String KEY_FILLED_PICTURE_PATHS = "kfpp";
 
     public FeedbackRepositoryImpl(
-            @NonNull Context context, @NonNull UserFilledTextsFetcher userTextsFetcher,
-            int maxCountOfPicturesToUpload) {
-        super(context);
+            @NonNull Context context, @NonNull CoroutineScope coroutineScope,
+            @NonNull UserFilledTextsFetcher userTextsFetcher, int maxCountOfPicturesToUpload) {
+        super(context, coroutineScope);
         mUserFilledTextsFetcher = userTextsFetcher;
         mFeedbackSPs = new FeedbackSavedPrefs(context);
         mSavedFeedbackInfo = new FeedbackInfo();
         mPictures = new ArrayList<>(maxCountOfPicturesToUpload + 1);
-        //noinspection ConstantConditions
-        mPictures.add(BitmapUtils.drawableToBitmap(
-                AppCompatResources.getDrawable(context, R.drawable.ic_add_photo_gray_36dp)));
+        JCoroutine.launch(coroutineScope, Dispatchers.getIO(), () -> {
+            //noinspection ConstantConditions
+            Bitmap addPhoto = BitmapUtils.drawableToBitmap(
+                    AppCompatResources.getDrawable(context, R.drawable.ic_add_photo_gray_36dp));
+            JCoroutine.launch(coroutineScope, Dispatchers.getMain(), () -> {
+                mPictures.add(addPhoto);
+                if (mCallback != null) {
+                    mCallback.onPictureAdded(addPhoto);
+                }
+            });
+        });
     }
 
     private void cacheFeedbackInfo(String text, String contactWay, List<String> picturePaths) {
@@ -113,31 +126,34 @@ class FeedbackRepositoryImpl extends BaseRepository<FeedbackRepository.Callback>
     @Override
     public void restoreInstanceState(@Nullable Bundle savedInstanceState) {
         if (savedInstanceState == null) {
-            String feedbackText = mFeedbackSPs.getText();
-            String contactWay = mFeedbackSPs.getContactWay();
-            List<String> picturePaths = mFeedbackSPs.getPicturePaths();
-
-            cacheFeedbackInfo(feedbackText, contactWay, picturePaths);
-
-            setFeedbackText(feedbackText);
-            setContactWay(contactWay);
-            if (picturePaths != null) {
-                List<String> invalidPaths = null;
-                for (String path : picturePaths) {
-                    // 有可能该路径下的图片已被删除：如果删除了，从sp文件中移除该保存的路径
-                    if (!new File(path).exists()) {
-                        if (invalidPaths == null)
-                            invalidPaths = new LinkedList<>();
-                        invalidPaths.add(path);
-                        continue;
+            JCoroutine.launch(mCoroutineScope, Dispatchers.getIO(), () -> {
+                String feedbackText = mFeedbackSPs.getText();
+                String contactWay = mFeedbackSPs.getContactWay();
+                List<String> picturePaths = mFeedbackSPs.getPicturePaths();
+                if (picturePaths != null) {
+                    List<String> invalidPaths = null;
+                    for (String path : picturePaths) {
+                        // 有可能该路径下的图片已被删除：如果删除了，从sp文件中移除该保存的路径
+                        if (!new File(path).exists()) {
+                            if (invalidPaths == null)
+                                invalidPaths = new LinkedList<>();
+                            invalidPaths.add(path);
+                            continue;
+                        }
+                        JCoroutine.launch(mCoroutineScope, Dispatchers.getMain(),
+                                () -> addPicture(path));
+                    }
+                    if (invalidPaths != null) {
+                        picturePaths.removeAll(invalidPaths);
+                        mFeedbackSPs.edit().setPicturePaths(picturePaths).apply();
                     }
-                    addPicture(path);
-                }
-                if (invalidPaths != null) {
-                    picturePaths.removeAll(invalidPaths);
-                    mFeedbackSPs.edit().setPicturePaths(picturePaths).apply();
                 }
-            }
+                JCoroutine.launch(mCoroutineScope, Dispatchers.getMain(), () -> {
+                    cacheFeedbackInfo(feedbackText, contactWay, picturePaths);
+                    setFeedbackText(feedbackText);
+                    setContactWay(contactWay);
+                });
+            });
         } else {
             String[] savedPicturePaths = (String[])
                     savedInstanceState.getSerializable(KEY_SAVED_PICTURE_PATHS);
@@ -176,20 +192,21 @@ class FeedbackRepositoryImpl extends BaseRepository<FeedbackRepository.Callback>
         final List<String> picturePaths = mPicturePaths;
         if (picturePath != null && !picturePaths.contains(picturePath)) {
             picturePaths.add(picturePath);
-            Executors.SERIAL_EXECUTOR.execute(() -> {
-                final AtomicBoolean pictureRemoved = new AtomicBoolean();
-                Utils.runOnHandlerSync(Executors.MAIN_EXECUTOR.getHandler(),
-                        () -> {
-                            if (!picturePaths.contains(picturePath)) {
-                                pictureRemoved.set(true);
-                            }
-                        });
-                if (pictureRemoved.get()) {
-                    return;
-                }
+            JCoroutine.launch(mCoroutineScope, JCoroutine.SingleDispatcher, () -> {
+                do {
+                    try {
+                        if (JCoroutine.runBlocking(
+                                Dispatchers.getMain(), () -> !picturePaths.contains(picturePath))) {
+                            return;
+                        }
+                        break;
+                    } catch (InterruptedException e) {
+                        Log.w(TAG, e);
+                    }
+                } while (CoroutineScopeKt.isActive(mCoroutineScope));
                 final Bitmap bitmap = BitmapUtils.decodeRotatedBitmapFormFile(picturePath);
                 if (bitmap != null) {
-                    Executors.MAIN_EXECUTOR.post(() -> {
+                    JCoroutine.launch(mCoroutineScope, Dispatchers.getMain(), () -> {
                         if (picturePaths.contains(picturePath)) {
                             List<String> loadedPicturePaths = mLoadedPicturePaths;
                             List<Bitmap> pictures = mPictures;
diff --git a/app/src/main/java/com/liuzhenlin/videos/model/LocalSearchedVideoListModel.kt b/app/src/main/java/com/liuzhenlin/videos/model/LocalSearchedVideoListModel.kt
index 3128436..10373a2 100644
--- a/app/src/main/java/com/liuzhenlin/videos/model/LocalSearchedVideoListModel.kt
+++ b/app/src/main/java/com/liuzhenlin/videos/model/LocalSearchedVideoListModel.kt
@@ -10,6 +10,7 @@ import android.content.Context
 import android.os.AsyncTask
 import com.liuzhenlin.common.Consts
 import com.liuzhenlin.common.Consts.EMPTY_STRING
+import com.liuzhenlin.common.utils.AppScope
 import com.liuzhenlin.common.utils.Executors
 import com.liuzhenlin.videos.SORT_MODE_RELEVANCY_DESC
 import com.liuzhenlin.videos.allEqual
@@ -25,6 +26,10 @@ import com.liuzhenlin.videos.view.fragment.VideoListItemDeleteOnDiskListener
 import com.liuzhenlin.videos.view.fragment.VideoListItemRenameResultCallback
 import com.liuzhenlin.videos.view.fragment.deleteOnDisk
 import com.liuzhenlin.videos.view.fragment.renameTo
+import kotlinx.coroutines.CoroutineScope
+import kotlinx.coroutines.Dispatchers
+import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 
 /**
  * @author 刘振林
@@ -56,9 +61,10 @@ interface ILocalSearchedVideoListModel {
     }
 }
 
-class LocalSearchedVideoListModel(context: Context)
-    : BaseModel<Nothing, MutableList<Video>?, ILocalSearchedVideoListModel.Callback>(context),
-        ILocalSearchedVideoListModel {
+class LocalSearchedVideoListModel(context: Context, coroutineScope: CoroutineScope) :
+    BaseModel<Nothing, MutableList<Video>?, ILocalSearchedVideoListModel.Callback>(
+        context, coroutineScope),
+    ILocalSearchedVideoListModel {
 
     private val mVideos = arrayListOf<Video>()
     private val mSearchCache = SearchCache()
@@ -244,9 +250,9 @@ class LocalSearchedVideoListModel(context: Context)
 
     override fun deleteVideo(video: Video, listener: VideoListItemDeleteOnDiskListener<Video>?) {
         listener?.onItemsDeleteStart(video)
-        Executors.THREAD_POOL_EXECUTOR.execute {
+        AppScope.launch(Dispatchers.IO) {
             arrayOf(video).deleteOnDisk()
-            Executors.MAIN_EXECUTOR.execute {
+            withContext(Dispatchers.Main) {
                 listener?.onItemsDeleteFinish(video)
             }
         }
diff --git a/app/src/main/java/com/liuzhenlin/videos/model/LocalVideoListModel.kt b/app/src/main/java/com/liuzhenlin/videos/model/LocalVideoListModel.kt
index 8a83caf..7fc882e 100644
--- a/app/src/main/java/com/liuzhenlin/videos/model/LocalVideoListModel.kt
+++ b/app/src/main/java/com/liuzhenlin/videos/model/LocalVideoListModel.kt
@@ -12,6 +12,7 @@ import android.os.AsyncTask
 import android.os.Environment
 import android.os.Handler
 import com.liuzhenlin.common.Consts
+import com.liuzhenlin.common.utils.AppScope
 import com.liuzhenlin.common.utils.Executors
 import com.liuzhenlin.common.utils.FileUtils
 import com.liuzhenlin.videos.*
@@ -25,6 +26,10 @@ import com.liuzhenlin.videos.view.fragment.VideoListItemDeleteOnDiskListener
 import com.liuzhenlin.videos.view.fragment.VideoListItemRenameResultCallback
 import com.liuzhenlin.videos.view.fragment.deleteOnDisk
 import com.liuzhenlin.videos.view.fragment.renameTo
+import kotlinx.coroutines.CoroutineScope
+import kotlinx.coroutines.Dispatchers
+import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 import java.io.File
 import java.util.LinkedList
 
@@ -72,9 +77,12 @@ interface ILocalVideoListModel {
     }
 }
 
-class LocalVideoListModel(context: Context, override val parentVideoDir: VideoDirectory? = null)
-    : BaseModel<Nothing, MutableList<VideoListItem>?, ILocalVideoListModel.Callback>(context),
-        ILocalVideoListModel {
+class LocalVideoListModel(
+    context: Context, override val parentVideoDir: VideoDirectory? = null,
+    coroutineScope: CoroutineScope
+) : BaseModel<Nothing, MutableList<VideoListItem>?, ILocalVideoListModel.Callback>(
+        context, coroutineScope),
+    ILocalVideoListModel {
 
     private val mVideoListItems: MutableList<VideoListItem> =
             parentVideoDir?.videoListItems ?: mutableListOf()
@@ -436,9 +444,9 @@ class LocalVideoListModel(context: Context, override val parentVideoDir: VideoDi
     private fun deleteItemsOnDisk(vararg items: VideoListItem,
                                   listener: VideoListItemDeleteOnDiskListener<VideoListItem>?) {
         listener?.onItemsDeleteStart(*items)
-        Executors.THREAD_POOL_EXECUTOR.execute {
+        AppScope.launch(Dispatchers.IO) {
             items.deleteOnDisk()
-            Executors.MAIN_EXECUTOR.execute {
+            withContext(Dispatchers.Main) {
                 listener?.onItemsDeleteFinish(*items)
             }
         }
diff --git a/app/src/main/java/com/liuzhenlin/videos/model/OnlineVideoListModel.kt b/app/src/main/java/com/liuzhenlin/videos/model/OnlineVideoListModel.kt
index 2a64582..a3c044a 100644
--- a/app/src/main/java/com/liuzhenlin/videos/model/OnlineVideoListModel.kt
+++ b/app/src/main/java/com/liuzhenlin/videos/model/OnlineVideoListModel.kt
@@ -12,6 +12,7 @@ import androidx.core.util.AtomicFile
 import com.google.gson.Gson
 import com.liuzhenlin.common.Configs
 import com.liuzhenlin.common.Consts
+import com.liuzhenlin.common.utils.AppScope
 import com.liuzhenlin.common.utils.Executors
 import com.liuzhenlin.common.utils.IOUtils
 import com.liuzhenlin.common.utils.Utils
@@ -25,7 +26,7 @@ import java.net.URL
  * @author 刘振林
  */
 class OnlineVideoListModel(context: Context)
-    : BaseModel<Nothing, Array<TVGroup>?, BaseModel.Callback>(context) {
+    : BaseModel<Nothing, Array<TVGroup>?, BaseModel.Callback>(context, AppScope /* unused */) {
 
     override fun createAndStartLoader(): AsyncTask<*, *, *> {
         val loader = LoadTVsAsyncTask()
diff --git a/app/src/main/java/com/liuzhenlin/videos/model/VideoMoveRepository.kt b/app/src/main/java/com/liuzhenlin/videos/model/VideoMoveRepository.kt
index 9d33369..b888a66 100644
--- a/app/src/main/java/com/liuzhenlin/videos/model/VideoMoveRepository.kt
+++ b/app/src/main/java/com/liuzhenlin/videos/model/VideoMoveRepository.kt
@@ -7,7 +7,7 @@ package com.liuzhenlin.videos.model
 
 import android.content.Context
 import android.os.Bundle
-import com.liuzhenlin.common.utils.Executors
+import com.liuzhenlin.common.utils.AppScope
 import com.liuzhenlin.common.utils.FileUtils
 import com.liuzhenlin.common.utils.LateinitProperty
 import com.liuzhenlin.common.utils.Regex
@@ -23,6 +23,10 @@ import com.liuzhenlin.videos.insertVideoDir
 import com.liuzhenlin.videos.suffix
 import com.liuzhenlin.videos.title
 import com.liuzhenlin.videos.videoCount
+import kotlinx.coroutines.CoroutineScope
+import kotlinx.coroutines.Dispatchers
+import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 import java.io.File
 
 /**
@@ -55,14 +59,14 @@ interface VideoMoveRepository : Repository<VideoMoveRepository.Callback> {
 
     companion object {
         @JvmStatic
-        fun create(context: Context, args: Bundle?): VideoMoveRepository {
-            return VideoMoveRepositoryImpl(context, args)
+        fun create(context: Context, coroutine: CoroutineScope, args: Bundle?): VideoMoveRepository {
+            return VideoMoveRepositoryImpl(context, coroutine, args)
         }
     }
 }
 
-private class VideoMoveRepositoryImpl(context: Context, args: Bundle?)
-    : BaseRepository<VideoMoveRepository.Callback>(context), VideoMoveRepository {
+private class VideoMoveRepositoryImpl(context: Context, coroutine: CoroutineScope, args: Bundle?)
+    : BaseRepository<VideoMoveRepository.Callback>(context, coroutine), VideoMoveRepository {
 
     override val targetDirs = object : LateinitProperty<Array<VideoDirectory>>() {
         override fun initialize(): Array<VideoDirectory> {
@@ -166,9 +170,9 @@ private class VideoMoveRepositoryImpl(context: Context, args: Bundle?)
 
     override fun moveVideosToCheckedDir() {
         mCallback?.onVideoMoveStart()
-        Executors.THREAD_POOL_EXECUTOR.execute {
+        AppScope.launch(Dispatchers.IO) {
             val moved = moveVideosToCheckedDirSync()
-            Executors.MAIN_EXECUTOR.execute {
+            withContext(Dispatchers.Main) {
                 mCallback?.onVideoMoveFinish(moved)
             }
         }
diff --git a/app/src/main/java/com/liuzhenlin/videos/model/VideoRepository.java b/app/src/main/java/com/liuzhenlin/videos/model/VideoRepository.java
index 1256a47..b66253d 100644
--- a/app/src/main/java/com/liuzhenlin/videos/model/VideoRepository.java
+++ b/app/src/main/java/com/liuzhenlin/videos/model/VideoRepository.java
@@ -11,16 +11,20 @@ import android.os.Bundle;
 
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
+import androidx.annotation.WorkerThread;
 
 import com.liuzhenlin.videos.bean.Video;
 
+import kotlinx.coroutines.CoroutineScope;
+
 public interface VideoRepository extends Repository<VideoRepository.Callback> {
 
     @NonNull
-    static VideoRepository create(@NonNull Context context) {
-        return new VideoRepositoryImpl(context);
+    static VideoRepository create(@NonNull Context context, @NonNull CoroutineScope coroutineScope) {
+        return new VideoRepositoryImpl(context, coroutineScope);
     }
 
+    @WorkerThread
     boolean initPlaylist(@Nullable Bundle savedInstanceState, @NonNull Intent intent);
 
     @Nullable Video[] getVideos();
diff --git a/app/src/main/java/com/liuzhenlin/videos/model/VideoRepositoryImpl.java b/app/src/main/java/com/liuzhenlin/videos/model/VideoRepositoryImpl.java
index 5fa057b..76a0e39 100644
--- a/app/src/main/java/com/liuzhenlin/videos/model/VideoRepositoryImpl.java
+++ b/app/src/main/java/com/liuzhenlin/videos/model/VideoRepositoryImpl.java
@@ -13,14 +13,19 @@ import android.os.Parcelable;
 
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
+import androidx.annotation.WorkerThread;
 
 import com.liuzhenlin.common.utils.FileUtils;
+import com.liuzhenlin.common.utils.JCoroutine;
 import com.liuzhenlin.videos.Consts;
 import com.liuzhenlin.videos.bean.Video;
 import com.liuzhenlin.videos.dao.VideoListItemDao;
 
 import java.io.Serializable;
 
+import kotlinx.coroutines.CoroutineScope;
+import kotlinx.coroutines.Dispatchers;
+
 import static com.liuzhenlin.common.Consts.NO_ID;
 
 class VideoRepositoryImpl extends BaseRepository<VideoRepository.Callback>
@@ -31,104 +36,120 @@ class VideoRepositoryImpl extends BaseRepository<VideoRepository.Callback>
 
     private static final String KEY_VIDEO_INDEX = "kvi";
 
-    public VideoRepositoryImpl(@NonNull Context context) {
-        super(context);
+    public VideoRepositoryImpl(@NonNull Context context, @NonNull CoroutineScope coroutineScope) {
+        super(context, coroutineScope);
     }
 
+    @WorkerThread
     @Override
     public boolean initPlaylist(@Nullable Bundle savedInstanceState, @NonNull Intent intent) {
         final boolean stateRestore = savedInstanceState != null;
+        Video[] videos = null;
+        int videoIndex = -1;
         Video video;
+        boolean initSuceess = false;
 
         Parcelable[] parcelables = intent.getParcelableArrayExtra(Consts.KEY_VIDEOS);
         if (parcelables != null) {
             final int length = parcelables.length;
             if (length > 0) {
-                mVideos = new Video[length];
+                videos = new Video[length];
                 for (int i = 0; i < length; i++) {
                     video = (Video) parcelables[i];
                     if (stateRestore) {
-                        video.setProgress(
-                                VideoListItemDao.getSingleton(mContext).getVideoProgress(video.getId()));
+                        video.setProgress(getVideoProgressFromDB(video));
                     }
-                    mVideos[i] = video;
+                    videos[i] = video;
                 }
                 if (stateRestore) {
-                    mVideoIndex = savedInstanceState.getInt(KEY_VIDEO_INDEX);
+                    videoIndex = savedInstanceState.getInt(KEY_VIDEO_INDEX);
                 } else {
-                    mVideoIndex = intent.getIntExtra(Consts.KEY_SELECTION, 0);
-                    if (mVideoIndex < 0 || mVideoIndex >= length) {
-                        mVideoIndex = 0;
+                    videoIndex = intent.getIntExtra(Consts.KEY_SELECTION, 0);
+                    if (videoIndex < 0 || videoIndex >= length) {
+                        videoIndex = 0;
                     }
                 }
-                return true;
+                initSuceess = true;
             }
-            return false;
         }
 
-        video = intent.getParcelableExtra(Consts.KEY_VIDEO);
-        if (video != null) {
-            if (stateRestore) {
-                video.setProgress(
-                        VideoListItemDao.getSingleton(mContext).getVideoProgress(video.getId()));
+        if (!initSuceess) {
+            video = intent.getParcelableExtra(Consts.KEY_VIDEO);
+            if (video != null) {
+                if (stateRestore) {
+                    video.setProgress(getVideoProgressFromDB(video));
+                }
+                videos = new Video[]{video};
+                videoIndex = 0;
+                initSuceess = true;
             }
-            mVideos = new Video[]{video};
-            mVideoIndex = 0;
-            return true;
         }
 
-        Parcelable[] videoUriParcels = (Parcelable[])
-                intent.getSerializableExtra(Consts.KEY_VIDEO_URIS);
-        Serializable[] videoTitleSerials = (Serializable[])
-                intent.getSerializableExtra(Consts.KEY_VIDEO_TITLES);
-        if (videoUriParcels != null) {
-            final int length = videoUriParcels.length;
-            if (length > 0) {
-                mVideos = new Video[length];
-                for (int i = 0; i < length; i++) {
-                    video = buildVideoForUri((Uri) videoUriParcels[i],
-                            (String) (videoTitleSerials != null ? videoTitleSerials[i] : null));
-                    if (stateRestore && video.getId() != NO_ID) {
-                        video.setProgress(
-                                VideoListItemDao.getSingleton(mContext).getVideoProgress(video.getId()));
+        if (!initSuceess) {
+            Parcelable[] videoUriParcels = (Parcelable[])
+                    intent.getSerializableExtra(Consts.KEY_VIDEO_URIS);
+            Serializable[] videoTitleSerials = (Serializable[])
+                    intent.getSerializableExtra(Consts.KEY_VIDEO_TITLES);
+            if (videoUriParcels != null) {
+                final int length = videoUriParcels.length;
+                if (length > 0) {
+                    videos = new Video[length];
+                    for (int i = 0; i < length; i++) {
+                        video = buildVideoForUri((Uri) videoUriParcels[i],
+                                (String) (videoTitleSerials != null ? videoTitleSerials[i] : null));
+                        if (stateRestore && video.getId() != NO_ID) {
+                            video.setProgress(getVideoProgressFromDB(video));
+                        }
+                        videos[i] = video;
                     }
-                    mVideos[i] = video;
-                }
-                if (stateRestore) {
-                    mVideoIndex = savedInstanceState.getInt(KEY_VIDEO_INDEX);
-                } else {
-                    mVideoIndex = intent.getIntExtra(Consts.KEY_SELECTION, 0);
-                    if (mVideoIndex < 0 || mVideoIndex >= length) {
-                        mVideoIndex = 0;
+                    if (stateRestore) {
+                        videoIndex = savedInstanceState.getInt(KEY_VIDEO_INDEX);
+                    } else {
+                        videoIndex = intent.getIntExtra(Consts.KEY_SELECTION, 0);
+                        if (videoIndex < 0 || videoIndex >= length) {
+                            videoIndex = 0;
+                        }
                     }
+                    initSuceess = true;
                 }
-                return true;
             }
-            return false;
         }
 
-        Uri uri = intent.getData();
-        if (uri == null) {
-            uri = intent.getParcelableExtra(Intent.EXTRA_STREAM);
+        if (!initSuceess) {
+            Uri uri = intent.getData();
             if (uri == null) {
-                CharSequence uriCharSequence = intent.getCharSequenceExtra(Intent.EXTRA_TEXT);
-                if (uriCharSequence != null) {
-                    uri = Uri.parse(uriCharSequence.toString());
+                uri = intent.getParcelableExtra(Intent.EXTRA_STREAM);
+                if (uri == null) {
+                    CharSequence uriCharSequence = intent.getCharSequenceExtra(Intent.EXTRA_TEXT);
+                    if (uriCharSequence != null) {
+                        uri = Uri.parse(uriCharSequence.toString());
+                    }
                 }
             }
-        }
-        if (uri != null) {
-            video = buildVideoForUri(uri, intent.getStringExtra(Consts.KEY_VIDEO_TITLE));
-            if (stateRestore && video.getId() != NO_ID) {
-                video.setProgress(
-                        VideoListItemDao.getSingleton(mContext).getVideoProgress(video.getId()));
+            if (uri != null) {
+                video = buildVideoForUri(uri, intent.getStringExtra(Consts.KEY_VIDEO_TITLE));
+                if (stateRestore && video.getId() != NO_ID) {
+                    video.setProgress(getVideoProgressFromDB(video));
+                }
+                videos = new Video[]{video};
+                videoIndex = 0;
+                initSuceess = true;
             }
-            mVideos = new Video[]{video};
-            mVideoIndex = 0;
-            return true;
         }
 
-        return false;
+        if (initSuceess) {
+            final Video[] vs = videos;
+            final int vi = videoIndex;
+            JCoroutine.withContext(Dispatchers.getMain(), () -> {
+                mVideos = vs;
+                mVideoIndex = vi;
+            });
+        }
+        return initSuceess;
+    }
+
+    private int getVideoProgressFromDB(Video video) {
+        return VideoListItemDao.getSingleton(mContext).getVideoProgress(video.getId());
     }
 
     private Video buildVideoForUri(Uri uri, String videoTitle) {
@@ -222,7 +243,8 @@ class VideoRepositoryImpl extends BaseRepository<VideoRepository.Callback>
         if (updateDB) {
             final long id = video.getId();
             if (id != NO_ID) {
-                VideoListItemDao.getSingleton(mContext).setVideoProgress(id, progress);
+                JCoroutine.launch(mCoroutineScope, Dispatchers.getIO(),
+                        () -> VideoListItemDao.getSingleton(mContext).setVideoProgress(id, progress));
             }
         }
     }
diff --git a/app/src/main/java/com/liuzhenlin/videos/presenter/FeedbackPresenter.java b/app/src/main/java/com/liuzhenlin/videos/presenter/FeedbackPresenter.java
index a1b3107..8ee9ea4 100644
--- a/app/src/main/java/com/liuzhenlin/videos/presenter/FeedbackPresenter.java
+++ b/app/src/main/java/com/liuzhenlin/videos/presenter/FeedbackPresenter.java
@@ -43,16 +43,21 @@ class FeedbackPresenter extends Presenter<IFeedbackView> implements IFeedbackPre
     @Override
     public void attachToView(@NonNull IFeedbackView view) {
         super.attachToView(view);
-        mFeedbackRepository = FeedbackRepository.create(mContext, this, MAX_COUNT_UPLOAD_PICTURES);
-        mFeedbackRepository.setCallback(this);
+        if (mFeedbackRepository == null) {
+            mFeedbackRepository = FeedbackRepository.create(mContext, mCoroutineScope, this,
+                    MAX_COUNT_UPLOAD_PICTURES);
+            mFeedbackRepository.setCallback(this);
+        }
     }
 
     @Override
-    public void detachFromView(@NonNull IFeedbackView view) {
-        mFeedbackRepository.clearPictures(true);
-        mFeedbackRepository.setCallback(null);
-        mFeedbackRepository = null;
-        super.detachFromView(view);
+    protected void onCleared() {
+        super.onCleared();
+        if (mFeedbackRepository != null) {
+            mFeedbackRepository.clearPictures(true);
+            mFeedbackRepository.setCallback(null);
+            mFeedbackRepository = null;
+        }
     }
 
     @Override
diff --git a/app/src/main/java/com/liuzhenlin/videos/presenter/IFeedbackPresenter.java b/app/src/main/java/com/liuzhenlin/videos/presenter/IFeedbackPresenter.java
index 529b11f..eb181f5 100644
--- a/app/src/main/java/com/liuzhenlin/videos/presenter/IFeedbackPresenter.java
+++ b/app/src/main/java/com/liuzhenlin/videos/presenter/IFeedbackPresenter.java
@@ -20,8 +20,9 @@ import com.liuzhenlin.videos.view.activity.IFeedbackView;
 public interface IFeedbackPresenter extends IPresenter<IFeedbackView> {
 
     @NonNull
-    static IFeedbackPresenter newInstance() {
-        return new FeedbackPresenter();
+    static <T extends Presenter<IFeedbackView> & IFeedbackPresenter> Class<T> getImplClass() {
+        //noinspection unchecked
+        return (Class<T>) FeedbackPresenter.class;
     }
 
     void restoreInstanceState(@Nullable Bundle savedInstanceState);
diff --git a/app/src/main/java/com/liuzhenlin/videos/presenter/IVideoPresenter.java b/app/src/main/java/com/liuzhenlin/videos/presenter/IVideoPresenter.java
index 16145c0..b791260 100644
--- a/app/src/main/java/com/liuzhenlin/videos/presenter/IVideoPresenter.java
+++ b/app/src/main/java/com/liuzhenlin/videos/presenter/IVideoPresenter.java
@@ -53,7 +53,8 @@ public interface IVideoPresenter extends IPresenter<IVideoView> {
     TextureVideoView.PlayListAdapter<? extends IVideoView.PlaylistViewHolder> newPlaylistAdapter();
 
     @NonNull
-    static IVideoPresenter newInstance() {
-        return new VideoPresenter();
+    static <T extends Presenter<IVideoView> & IVideoPresenter> Class<T> getImplClass() {
+        //noinspection unchecked
+        return (Class<T>) VideoPresenter.class;
     }
 }
diff --git a/app/src/main/java/com/liuzhenlin/videos/presenter/LocalSearchedVideosPresenter.kt b/app/src/main/java/com/liuzhenlin/videos/presenter/LocalSearchedVideosPresenter.kt
index 2f9460a..71831f4 100644
--- a/app/src/main/java/com/liuzhenlin/videos/presenter/LocalSearchedVideosPresenter.kt
+++ b/app/src/main/java/com/liuzhenlin/videos/presenter/LocalSearchedVideosPresenter.kt
@@ -41,8 +41,10 @@ interface ILocalSearchedVideosPresenter : IPresenter<ILocalSearchedVideosView>,
 
     companion object {
         @JvmStatic
-        fun newInstance(): ILocalSearchedVideosPresenter {
-            return LocalSearchedVideosPresenter()
+        fun <T> getImplClass(): Class<T> where T : Presenter<ILocalSearchedVideosView>,
+                                               T : ILocalSearchedVideosPresenter {
+            @Suppress("UNCHECKED_CAST")
+            return LocalSearchedVideosPresenter::class.java as Class<T>
         }
     }
 }
@@ -61,7 +63,7 @@ class LocalSearchedVideosPresenter : Presenter<ILocalSearchedVideosView>(),
         super.attachToView(view)
         var model = mModel
         if (model == null) {
-            model = LocalSearchedVideoListModel(mContext)
+            model = LocalSearchedVideoListModel(mContext, mCoroutineScope)
             model.addOnLoadListener(object : OnLoadListener<Nothing, MutableList<Video>?> {
                 override fun onLoadStart() = onVideoItemsLoadStart()
 
@@ -76,10 +78,10 @@ class LocalSearchedVideosPresenter : Presenter<ILocalSearchedVideosView>(),
         model.setVideos(view.getArguments()?.getParcelableArrayList(KEY_VIDEOS) ?: model.videos)
     }
 
-    override fun detachFromView(view: ILocalSearchedVideosView) {
-        super.detachFromView(view)
+    override fun onCleared() {
+        super.onCleared()
         val videos = mModel?.videos ?: arrayListOf()
-        view.onReturnResult(RESULT_CODE_LOCAL_SEARCHED_VIDEOS_FRAGMENT,
+        mView?.onReturnResult(RESULT_CODE_LOCAL_SEARCHED_VIDEOS_FRAGMENT,
                 Intent().putParcelableArrayListExtra(
                         KEY_VIDEOS, videos as? ArrayList<Video> ?: ArrayList(videos)))
         mModel?.setCallback(null)
diff --git a/app/src/main/java/com/liuzhenlin/videos/presenter/LocalVideoListPresenter.kt b/app/src/main/java/com/liuzhenlin/videos/presenter/LocalVideoListPresenter.kt
index cffa775..f23f44e 100644
--- a/app/src/main/java/com/liuzhenlin/videos/presenter/LocalVideoListPresenter.kt
+++ b/app/src/main/java/com/liuzhenlin/videos/presenter/LocalVideoListPresenter.kt
@@ -81,8 +81,10 @@ interface ILocalVideoListPresenter : IPresenter<ILocalVideoListView>,
 
     companion object {
         @JvmStatic
-        fun newInstance(): ILocalVideoListPresenter {
-            return LocalVideoListPresenter()
+        fun <T> getImplClass(): Class<T> where T : Presenter<ILocalVideoListView>,
+                                               T : ILocalVideoListPresenter {
+            @Suppress("UNCHECKED_CAST")
+            return LocalVideoListPresenter::class.java as Class<T>
         }
     }
 }
@@ -101,7 +103,7 @@ class LocalVideoListPresenter : Presenter<ILocalVideoListView>(), ILocalVideoLis
     private val mModel: LocalVideoListModel
         get() {
             if (_mModel == null) {
-                _mModel = LocalVideoListModel(App.getInstanceUnsafe()!!)
+                _mModel = LocalVideoListModel(App.getInstanceUnsafe()!!, null, mCoroutineScope)
             }
             return _mModel!!
         }
@@ -119,7 +121,8 @@ class LocalVideoListPresenter : Presenter<ILocalVideoListView>(), ILocalVideoLis
     override fun attachToView(view: ILocalVideoListView) {
         super.attachToView(view)
         if (view.getArguments()?.containsKey(KEY_VIDEODIR) == true) {
-            _mModel = LocalVideoListModel(mContext, view.getArguments()?.getParcelable(KEY_VIDEODIR))
+            _mModel = LocalVideoListModel(mContext, view.getArguments()?.getParcelable(KEY_VIDEODIR),
+                    mCoroutineScope)
         }
         mModel.setCallback(this)
         mModel.addOnLoadListener(object : OnLoadListener<Nothing, MutableList<VideoListItem>?> {
@@ -144,11 +147,6 @@ class LocalVideoListPresenter : Presenter<ILocalVideoListView>(), ILocalVideoLis
 
     override fun detachFromView(view: ILocalVideoListView) {
         super.detachFromView(view)
-        if (mSublist) {
-            view.onReturnResult(
-                    RESULT_CODE_LOCAL_VIDEO_SUBLIST_FRAGMENT,
-                    Intent().putExtra(KEY_VIDEODIR, mModel.parentVideoDir))
-        }
         mModel.setCallback(null)
         mVideosLoadListener?.let {
             mModel.removeOnLoadListener(it)
@@ -156,6 +154,15 @@ class LocalVideoListPresenter : Presenter<ILocalVideoListView>(), ILocalVideoLis
         }
     }
 
+    override fun onCleared() {
+        super.onCleared()
+        if (mSublist) {
+            mView?.onReturnResult(
+                    RESULT_CODE_LOCAL_VIDEO_SUBLIST_FRAGMENT,
+                    Intent().putExtra(KEY_VIDEODIR, mModel.parentVideoDir))
+        }
+    }
+
     override fun onViewCreated(view: ILocalVideoListView) {
         super.onViewCreated(view)
         view.init(mSublist, mModel.parentVideoDir?.name, mModel.parentVideoDir?.path,
diff --git a/app/src/main/java/com/liuzhenlin/videos/presenter/Presenter.java b/app/src/main/java/com/liuzhenlin/videos/presenter/Presenter.java
index a91ca20..8a73ea3 100644
--- a/app/src/main/java/com/liuzhenlin/videos/presenter/Presenter.java
+++ b/app/src/main/java/com/liuzhenlin/videos/presenter/Presenter.java
@@ -10,14 +10,23 @@ import android.content.Context;
 
 import androidx.annotation.NonNull;
 import androidx.core.util.ObjectsCompat;
+import androidx.lifecycle.ViewModel;
+import androidx.lifecycle.ViewModelProvider;
+import androidx.lifecycle.ViewModelStoreOwner;
 
+import com.liuzhenlin.common.utils.Coroutines;
+import com.liuzhenlin.common.utils.ReflectionUtils;
 import com.liuzhenlin.videos.view.IView;
 
+import kotlinx.coroutines.CoroutineScope;
+
 /**
  * @author 刘振林
  */
 @SuppressWarnings("rawtypes")
-public class Presenter<V extends IView> implements IPresenter<V> {
+public class Presenter<V extends IView> extends ViewModel implements IPresenter<V> {
+
+    protected final CoroutineScope mCoroutineScope = Coroutines.getViewModelScope(this);
 
     protected V mView;
     protected Context mThemedContext;
@@ -72,4 +81,31 @@ public class Presenter<V extends IView> implements IPresenter<V> {
     @Override
     public void onViewDestroyed(@NonNull V view) {
     }
+
+    public static class Provider {
+
+        private static final ViewModelProvider.Factory sViewModelFactory =
+                new ViewModelProvider.Factory() {
+                    @NonNull
+                    @Override
+                    public <T extends ViewModel> T create(@NonNull Class<T> modelClass) {
+                        try {
+                            return ReflectionUtils.getDeclaredConstructor(modelClass).newInstance();
+                        } catch (Exception e) {
+                            throw new RuntimeException("Cannot create an instance of" + modelClass, e);
+                        }
+                    }
+                };
+
+        private final ViewModelProvider mViewModelProvider;
+
+        public Provider(@NonNull ViewModelStoreOwner owner) {
+            mViewModelProvider = new ViewModelProvider(owner, sViewModelFactory);
+        }
+
+        @NonNull
+        public <P extends Presenter<V>, V extends IView> P get(@NonNull Class<P> presenterClass) {
+            return mViewModelProvider.get(presenterClass);
+        }
+    }
 }
diff --git a/app/src/main/java/com/liuzhenlin/videos/presenter/VideoMovePresenter.kt b/app/src/main/java/com/liuzhenlin/videos/presenter/VideoMovePresenter.kt
index 96490cc..e4e6b8b 100644
--- a/app/src/main/java/com/liuzhenlin/videos/presenter/VideoMovePresenter.kt
+++ b/app/src/main/java/com/liuzhenlin/videos/presenter/VideoMovePresenter.kt
@@ -25,8 +25,9 @@ interface IVideoMovePresenter : IPresenter<IVideoMoveView> {
 
     companion object {
         @JvmStatic
-        fun newInstance(): IVideoMovePresenter {
-            return VideoMovePresenter()
+        fun <T> getImplClass(): Class<T> where T : Presenter<IVideoMoveView>, T : IVideoMovePresenter {
+            @Suppress("UNCHECKED_CAST")
+            return VideoMovePresenter::class.java as Class<T>
         }
     }
 }
@@ -38,7 +39,8 @@ class VideoMovePresenter : Presenter<IVideoMoveView>(), IVideoMovePresenter,
 
     override fun attachToView(view: IVideoMoveView) {
         super.attachToView(view)
-        mVideoMoveRepository = VideoMoveRepository.create(mContext, view.getArguments())
+        mVideoMoveRepository =
+                VideoMoveRepository.create(mContext, mCoroutineScope, view.getArguments())
         mVideoMoveRepository!!.setCallback(this)
     }
 
diff --git a/app/src/main/java/com/liuzhenlin/videos/presenter/VideoPresenter.java b/app/src/main/java/com/liuzhenlin/videos/presenter/VideoPresenter.java
index fafb1e9..99c9e4f 100644
--- a/app/src/main/java/com/liuzhenlin/videos/presenter/VideoPresenter.java
+++ b/app/src/main/java/com/liuzhenlin/videos/presenter/VideoPresenter.java
@@ -13,6 +13,7 @@ import android.view.ViewGroup;
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
 
+import com.liuzhenlin.common.utils.JCoroutine;
 import com.liuzhenlin.common.utils.ShareUtils;
 import com.liuzhenlin.common.utils.Synthetic;
 import com.liuzhenlin.texturevideoview.TextureVideoView;
@@ -27,6 +28,8 @@ import com.liuzhenlin.videos.view.fragment.VideoListItemOpsKt;
 import java.io.File;
 import java.util.List;
 
+import kotlinx.coroutines.Dispatchers;
+
 /**
  * @author 刘振林
  */
@@ -38,15 +41,19 @@ class VideoPresenter extends Presenter<IVideoView> implements IVideoPresenter,
     @Override
     public void attachToView(@NonNull IVideoView view) {
         super.attachToView(view);
-        mVideoRepository = VideoRepository.create(mContext);
-        mVideoRepository.setCallback(this);
+        if (mVideoRepository == null) {
+            mVideoRepository = VideoRepository.create(mContext, mCoroutineScope);
+            mVideoRepository.setCallback(this);
+        }
     }
 
     @Override
-    public void detachFromView(@NonNull IVideoView view) {
-        super.detachFromView(view);
-        mVideoRepository.setCallback(null);
-        mVideoRepository = null;
+    protected void onCleared() {
+        super.onCleared();
+        if (mVideoRepository != null) {
+            mVideoRepository.setCallback(null);
+            mVideoRepository = null;
+        }
     }
 
     @Override
@@ -82,13 +89,18 @@ class VideoPresenter extends Presenter<IVideoView> implements IVideoPresenter,
         if (repository == null) {
             return;
         }
-        if (repository.initPlaylist(savedInstanceState, intent)) {
-            if (callback != null)
-                callback.onInitialized(repository.getVideos(), repository.getVideoIndex());
-        } else {
-            if (callback != null)
-                callback.onInitializationFail();
-        }
+        JCoroutine.launch(mCoroutineScope, Dispatchers.getIO(), () -> {
+            boolean initialized = repository.initPlaylist(savedInstanceState, intent);
+            JCoroutine.launch(mCoroutineScope, Dispatchers.getMain(), () -> {
+                if (initialized) {
+                    if (callback != null)
+                        callback.onInitialized(repository.getVideos(), repository.getVideoIndex());
+                } else {
+                    if (callback != null)
+                        callback.onInitializationFail();
+                }
+            });
+        });
     }
 
     @Override
diff --git a/app/src/main/java/com/liuzhenlin/videos/view/activity/FeedbackActivity.java b/app/src/main/java/com/liuzhenlin/videos/view/activity/FeedbackActivity.java
index 1138bb5..cba954b 100644
--- a/app/src/main/java/com/liuzhenlin/videos/view/activity/FeedbackActivity.java
+++ b/app/src/main/java/com/liuzhenlin/videos/view/activity/FeedbackActivity.java
@@ -59,6 +59,7 @@ import com.liuzhenlin.videos.Consts;
 import com.liuzhenlin.videos.R;
 import com.liuzhenlin.videos.dao.AppPrefs;
 import com.liuzhenlin.videos.presenter.IFeedbackPresenter;
+import com.liuzhenlin.videos.presenter.Presenter;
 import com.liuzhenlin.videos.view.adapter.GalleryPagerAdapter;
 
 import java.util.ArrayList;
@@ -85,7 +86,7 @@ public class FeedbackActivity extends BaseActivity implements IFeedbackView, Vie
 
     @Synthetic boolean mShouldSaveDataOnDestroy;
 
-    @Synthetic final IFeedbackPresenter mPresenter = IFeedbackPresenter.newInstance();
+    @Synthetic IFeedbackPresenter mPresenter;
 
     @Nullable
     @Override
@@ -196,6 +197,7 @@ public class FeedbackActivity extends BaseActivity implements IFeedbackView, Vie
             return false;
         });
 
+        mPresenter = new Presenter.Provider(this).get(IFeedbackPresenter.getImplClass());
         mPresenter.attachToView(this);
 
         BaseAdapter adapter = mPresenter.getPictureGridAdapter();
diff --git a/app/src/main/java/com/liuzhenlin/videos/view/activity/MainActivity.java b/app/src/main/java/com/liuzhenlin/videos/view/activity/MainActivity.java
index 9aa2e3b..ecd25c1 100644
--- a/app/src/main/java/com/liuzhenlin/videos/view/activity/MainActivity.java
+++ b/app/src/main/java/com/liuzhenlin/videos/view/activity/MainActivity.java
@@ -58,10 +58,11 @@ import com.liuzhenlin.common.compat.ViewCompatibility;
 import com.liuzhenlin.common.listener.OnBackPressedListener;
 import com.liuzhenlin.common.utils.BitmapUtils;
 import com.liuzhenlin.common.utils.ColorUtils;
+import com.liuzhenlin.common.utils.Coroutines;
 import com.liuzhenlin.common.utils.DensityUtils;
-import com.liuzhenlin.common.utils.Executors;
 import com.liuzhenlin.common.utils.FileUtils;
 import com.liuzhenlin.common.utils.IOUtils;
+import com.liuzhenlin.common.utils.JCoroutine;
 import com.liuzhenlin.common.utils.TextViewUtils;
 import com.liuzhenlin.common.utils.ThemeUtils;
 import com.liuzhenlin.common.utils.TransitionUtils;
@@ -87,6 +88,9 @@ import java.io.IOException;
 import java.lang.ref.WeakReference;
 import java.util.LinkedHashMap;
 
+import kotlinx.coroutines.CoroutineScope;
+import kotlinx.coroutines.Dispatchers;
+
 import static com.liuzhenlin.common.Consts.EMPTY_STRING;
 import static com.liuzhenlin.videos.Consts.TEXT_COLOR_PRIMARY_DARK;
 import static com.liuzhenlin.videos.Consts.TEXT_COLOR_PRIMARY_LIGHT;
@@ -370,7 +374,7 @@ public class MainActivity extends StatusBarTransparentActivity implements View.O
     }
 
     @Synthetic void setDrawerBackground(String path) {
-        Executors.SERIAL_EXECUTOR.execute(new LoadDrawerImageTask(this, path));
+        new LoadDrawerImageTask(this, path).execute();
     }
 
     private static final class LoadDrawerImageTask implements Runnable {
@@ -382,10 +386,30 @@ public class MainActivity extends StatusBarTransparentActivity implements View.O
             mImagePath = imagePath;
         }
 
+        void execute() {
+            CoroutineScope coroutineScope = getCoroutineScope();
+            if (coroutineScope != null) {
+                JCoroutine.launch(coroutineScope, JCoroutine.SingleDispatcher, this);
+            }
+        }
+
+        CoroutineScope getCoroutineScope() {
+            MainActivity activity = getActivity();
+            return activity == null ? null : Coroutines.getLifecycleScope(activity);
+        }
+
+        MainActivity getActivity() {
+            MainActivity activity = mActivityRef.get();
+            if (activity == null || activity.isFinishing()) {
+                return null;
+            }
+            return activity;
+        }
+
         @Override
         public void run() {
-            final MainActivity activity = mActivityRef.get();
-            if (activity == null || activity.isFinishing()) {
+            final MainActivity activity = getActivity();
+            if (activity == null) {
                 return;
             }
 
@@ -405,12 +429,15 @@ public class MainActivity extends StatusBarTransparentActivity implements View.O
         }
 
         void setDrawerBackground(Bitmap bmp) {
-            Executors.MAIN_EXECUTOR.post(() -> {
-                final MainActivity activity = mActivityRef.get();
-                if (activity != null && !activity.isFinishing()) {
-                    activity.setDrawerBackground(bmp, mImagePath);
-                }
-            });
+            final CoroutineScope coroutineScope = getCoroutineScope();
+            if (coroutineScope != null) {
+                JCoroutine.launch(coroutineScope, Dispatchers.getMain(), () -> {
+                    final MainActivity activity = getActivity();
+                    if (activity != null) {
+                        activity.setDrawerBackground(bmp, mImagePath);
+                    }
+                });
+            }
         }
     }
 
diff --git a/app/src/main/java/com/liuzhenlin/videos/view/activity/VideoActivity.java b/app/src/main/java/com/liuzhenlin/videos/view/activity/VideoActivity.java
index 5c3ce05..7abaf7e 100644
--- a/app/src/main/java/com/liuzhenlin/videos/view/activity/VideoActivity.java
+++ b/app/src/main/java/com/liuzhenlin/videos/view/activity/VideoActivity.java
@@ -64,6 +64,7 @@ import com.liuzhenlin.videos.R;
 import com.liuzhenlin.videos.bean.Video;
 import com.liuzhenlin.videos.dao.AppPrefs;
 import com.liuzhenlin.videos.presenter.IVideoPresenter;
+import com.liuzhenlin.videos.presenter.Presenter;
 import com.liuzhenlin.videos.utils.VideoUtils2;
 import com.liuzhenlin.videos.web.youtube.WebService;
 
@@ -98,7 +99,7 @@ public class VideoActivity extends BaseActivity implements IVideoView,
     private ImageView mLockUnlockOrientationButton;
 
     @Synthetic IVideoPlayer mVideoPlayer;
-    @Synthetic final IVideoPresenter mPresenter = IVideoPresenter.newInstance();
+    @Synthetic IVideoPresenter mPresenter;
 
     @Synthetic int mVideoWidth;
     @Synthetic int mVideoHeight;
@@ -257,19 +258,20 @@ public class VideoActivity extends BaseActivity implements IVideoView,
     @Override
     protected void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
+        setRequestedOrientation(mScreenOrientation);
+        setContentView(R.layout.activity_video);
+        initViews();
+        mPrivateFlags |= PFLAG_VIEW_CREATED;
+        mPresenter = new Presenter.Provider(this).get(IVideoPresenter.getImplClass());
         mPresenter.attachToView(this);
+        mPresenter.onViewCreated(this);
         mPresenter.initPlaylist(savedInstanceState, getIntent(),
                 new IVideoPresenter.PlaylistInitializationCallback() {
                     final VideoActivity _this = VideoActivity.this;
 
                     @Override
                     public void onInitialized(@NonNull Video[] playlist, int playlistIndex) {
-                        setRequestedOrientation(mScreenOrientation);
-                        setContentView(R.layout.activity_video);
-                        initViews(savedInstanceState, playlist, playlistIndex);
-                        mPresenter.onViewCreated(_this);
-                        mPrivateFlags |= PFLAG_VIEW_CREATED;
-                        mPresenter.playCurrentVideo();
+                        onPlaylistInitialized(playlist, playlistIndex);
                     }
 
                     @Override
@@ -286,6 +288,28 @@ public class VideoActivity extends BaseActivity implements IVideoView,
                 });
     }
 
+    @Synthetic void onPlaylistInitialized(Video[] playlist, int playlistIndex) {
+        final boolean needPlaylist = playlist.length > 1;
+        //noinspection rawtypes
+        TextureVideoView.PlayListAdapter adapter = mVideoView.getPlayListAdapter();
+        if (needPlaylist) {
+            if (adapter != null) {
+                //noinspection NotifyDataSetChanged
+                adapter.notifyDataSetChanged();
+            } else {
+                mVideoView.setPlayListAdapter(mPresenter.newPlaylistAdapter());
+            }
+            // Ensures the list scrolls to the position of the video to be played
+            ensureSelectedItemVisibleInPlaylist(playlistIndex);
+        } else {
+            mVideoView.setPlayListAdapter(null);
+        }
+        mVideoView.setCanSkipToPrevious(needPlaylist);
+        mVideoView.setCanSkipToNext(needPlaylist);
+
+        mPresenter.playCurrentVideo();
+    }
+
     @SuppressLint("MissingSuperCall")
     @Override
     protected void onNewIntent(Intent intent) {
@@ -296,22 +320,7 @@ public class VideoActivity extends BaseActivity implements IVideoView,
                         VideoActivity.super.onNewIntent(intent);
                         setIntent(intent);
 
-                        final boolean needPlaylist = playlist.length > 1;
-                        //noinspection rawtypes
-                        TextureVideoView.PlayListAdapter adapter = mVideoView.getPlayListAdapter();
-                        if (needPlaylist && adapter != null) {
-                            //noinspection NotifyDataSetChanged
-                            adapter.notifyDataSetChanged();
-                        }
-                        //noinspection unchecked
-                        mVideoView.setPlayListAdapter(
-                                needPlaylist
-                                        ? adapter == null ? mPresenter.newPlaylistAdapter() : adapter
-                                        : null);
-                        mVideoView.setCanSkipToPrevious(needPlaylist);
-                        mVideoView.setCanSkipToNext(needPlaylist);
-
-                        mPresenter.playCurrentVideo();
+                        onPlaylistInitialized(playlist, playlistIndex);
                     }
 
                     @Override
@@ -328,7 +337,7 @@ public class VideoActivity extends BaseActivity implements IVideoView,
         }
     }
 
-    @Synthetic void initViews(Bundle savedInstanceState, Video[] playlist, int playlistIndex) {
+    private void initViews() {
         mStatusHeight = SystemBarUtils.getStatusHeight(this);
         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
             mStatusBarView = findViewById(R.id.view_statusBar);
@@ -364,15 +373,6 @@ public class VideoActivity extends BaseActivity implements IVideoView,
         mLockUnlockOrientationButton.setOnClickListener(v ->
                 setScreenOrientationLocked((mPrivateFlags & PFLAG_SCREEN_ORIENTATION_LOCKED) == 0));
 
-        if (playlist.length > 1) {
-            mVideoView.setPlayListAdapter(mPresenter.newPlaylistAdapter());
-            mVideoView.setCanSkipToPrevious(true);
-            mVideoView.setCanSkipToNext(true);
-        }
-        // Ensures the list scrolls to the position of the video to be played
-        if (savedInstanceState == null && playlistIndex != 0) {
-            notifyPlaylistSelectionChanged(0, playlistIndex, true);
-        }
         videoPlayer.addVideoListener(new IVideoPlayer.VideoListener() {
             @Override
             public void onVideoStarted() {
@@ -1122,9 +1122,8 @@ public class VideoActivity extends BaseActivity implements IVideoView,
     @Override
     public void notifyPlaylistSelectionChanged(
             int oldPosition, int position, boolean checkNewItemVisibility) {
-        RecyclerView playlist = mVideoView.findViewById(R.id.rv_playlist);
         //noinspection rawtypes
-        RecyclerView.Adapter adapter = playlist.getAdapter();
+        RecyclerView.Adapter adapter = mVideoView.getPlayListAdapter();
         //noinspection ConstantConditions
         adapter.notifyItemChanged(oldPosition,
                 PLAYLIST_ADAPTER_PAYLOAD_VIDEO_PROGRESS_CHANGED
@@ -1133,32 +1132,37 @@ public class VideoActivity extends BaseActivity implements IVideoView,
                 PLAYLIST_ADAPTER_PAYLOAD_VIDEO_PROGRESS_CHANGED
                         | PLAYLIST_ADAPTER_PAYLOAD_HIGHLIGHT_ITEM_IF_SELECTED);
         if (checkNewItemVisibility) {
-            RecyclerView.LayoutManager lm = playlist.getLayoutManager();
-            if (lm instanceof LinearLayoutManager) {
-                LinearLayoutManager llm = (LinearLayoutManager) lm;
-                if (llm.findFirstCompletelyVisibleItemPosition() > position
-                        || llm.findLastCompletelyVisibleItemPosition() < position) {
-                    llm.scrollToPosition(position);
-                }
-            } else if (lm instanceof StaggeredGridLayoutManager) {
-                StaggeredGridLayoutManager sglm = (StaggeredGridLayoutManager) lm;
+            ensureSelectedItemVisibleInPlaylist(position);
+        }
+    }
 
-                int minFirstCompletelyVisiblePosition = 0;
-                for (int i : sglm.findFirstCompletelyVisibleItemPositions(null)) {
-                    minFirstCompletelyVisiblePosition = Math.min(minFirstCompletelyVisiblePosition, i);
-                }
-                if (minFirstCompletelyVisiblePosition > position) {
-                    sglm.scrollToPosition(position);
-                    return;
-                }
+    private void ensureSelectedItemVisibleInPlaylist(int selection) {
+        RecyclerView playlist = mVideoView.findViewById(R.id.rv_playlist);
+        RecyclerView.LayoutManager lm = playlist.getLayoutManager();
+        if (lm instanceof LinearLayoutManager) {
+            LinearLayoutManager llm = (LinearLayoutManager) lm;
+            if (llm.findFirstCompletelyVisibleItemPosition() > selection
+                    || llm.findLastCompletelyVisibleItemPosition() < selection) {
+                llm.scrollToPosition(selection);
+            }
+        } else if (lm instanceof StaggeredGridLayoutManager) {
+            StaggeredGridLayoutManager sglm = (StaggeredGridLayoutManager) lm;
 
-                int maxLastCompletelyVisiblePosition = 0;
-                for (int i : sglm.findLastCompletelyVisibleItemPositions(null)) {
-                    maxLastCompletelyVisiblePosition = Math.max(maxLastCompletelyVisiblePosition, i);
-                }
-                if (maxLastCompletelyVisiblePosition < position) {
-                    sglm.scrollToPosition(position);
-                }
+            int minFirstCompletelyVisiblePosition = 0;
+            for (int i : sglm.findFirstCompletelyVisibleItemPositions(null)) {
+                minFirstCompletelyVisiblePosition = Math.min(minFirstCompletelyVisiblePosition, i);
+            }
+            if (minFirstCompletelyVisiblePosition > selection) {
+                sglm.scrollToPosition(selection);
+                return;
+            }
+
+            int maxLastCompletelyVisiblePosition = 0;
+            for (int i : sglm.findLastCompletelyVisibleItemPositions(null)) {
+                maxLastCompletelyVisiblePosition = Math.max(maxLastCompletelyVisiblePosition, i);
+            }
+            if (maxLastCompletelyVisiblePosition < selection) {
+                sglm.scrollToPosition(selection);
             }
         }
     }
diff --git a/app/src/main/java/com/liuzhenlin/videos/view/activity/startup/LaunchProcessor.java b/app/src/main/java/com/liuzhenlin/videos/view/activity/startup/LaunchProcessor.java
index 339f9eb..6fdc70b 100644
--- a/app/src/main/java/com/liuzhenlin/videos/view/activity/startup/LaunchProcessor.java
+++ b/app/src/main/java/com/liuzhenlin/videos/view/activity/startup/LaunchProcessor.java
@@ -13,8 +13,9 @@ import android.os.Build;
 import androidx.annotation.NonNull;
 import androidx.lifecycle.LifecycleOwner;
 
-import com.liuzhenlin.common.utils.Executors;
+import com.liuzhenlin.common.utils.AppScope;
 import com.liuzhenlin.common.utils.FileUtils;
+import com.liuzhenlin.common.utils.JCoroutine;
 import com.liuzhenlin.common.utils.Utils;
 import com.liuzhenlin.videos.App;
 import com.liuzhenlin.videos.LegacyExternalStorageDataMigrator;
@@ -23,6 +24,8 @@ import com.liuzhenlin.videos.view.activity.MainActivity;
 import com.liuzhenlin.videos.view.activity.VideoActivity;
 import com.liuzhenlin.videos.web.youtube.YoutubePlaybackService;
 
+import kotlinx.coroutines.Dispatchers;
+
 public class LaunchProcessor<H extends Activity & LifecycleOwner> extends BaseProcessor<H> {
 
     @Override
@@ -40,7 +43,7 @@ public class LaunchProcessor<H extends Activity & LifecycleOwner> extends BasePr
             if (Utils.getAppTargetSdkVersion(mChain.host) >= Build.VERSION_CODES.R
                     && Build.VERSION.SDK_INT >= Build.VERSION_CODES.R
                     && !appPrefs.isLegacyExternalStorageDataMigrated()) {
-                Executors.THREAD_POOL_EXECUTOR.execute(() -> {
+                JCoroutine.launch(AppScope.INSTANCE, Dispatchers.getIO(), () -> {
                     boolean migrated = true;
                     if (hasAllFilesAccess) {
                         migrated = new LegacyExternalStorageDataMigrator(chain.host).migrate();
diff --git a/app/src/main/java/com/liuzhenlin/videos/view/fragment/LocalSearchedVideosFragment.kt b/app/src/main/java/com/liuzhenlin/videos/view/fragment/LocalSearchedVideosFragment.kt
index 2c55026..af6e3b5 100644
--- a/app/src/main/java/com/liuzhenlin/videos/view/fragment/LocalSearchedVideosFragment.kt
+++ b/app/src/main/java/com/liuzhenlin/videos/view/fragment/LocalSearchedVideosFragment.kt
@@ -45,6 +45,7 @@ import com.liuzhenlin.floatingmenu.FloatingMenu
 import com.liuzhenlin.videos.*
 import com.liuzhenlin.videos.bean.Video
 import com.liuzhenlin.videos.presenter.ILocalSearchedVideosPresenter
+import com.liuzhenlin.videos.presenter.Presenter
 import com.liuzhenlin.videos.utils.VideoUtils2
 import com.liuzhenlin.videos.view.IView
 import com.liuzhenlin.videos.view.fragment.Payloads.*
@@ -95,7 +96,8 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
     private lateinit var mAdapterWrapper: SearchedVideoListAdapterWrapper
     private var mSelectedItemIndex = NO_POSITION
 
-    internal val presenter = ILocalSearchedVideosPresenter.newInstance()
+    internal var presenter: ILocalSearchedVideosPresenter? = null
+        private set
 
     private var mVideoOptionsMenu: FloatingMenu? = null
     private var mDownX = 0
@@ -109,16 +111,16 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
     init {
         lifecycle.addObserver(object : DefaultLifecycleObserver {
             override fun onStart(owner: LifecycleOwner) =
-                    presenter.onViewStart(this@LocalSearchedVideosFragment)
+                    presenter?.onViewStart(this@LocalSearchedVideosFragment) ?: Unit
 
             override fun onResume(owner: LifecycleOwner) =
-                    presenter.onViewResume(this@LocalSearchedVideosFragment)
+                    presenter?.onViewResume(this@LocalSearchedVideosFragment) ?: Unit
 
             override fun onPause(owner: LifecycleOwner) =
-                    presenter.onViewPaused(this@LocalSearchedVideosFragment)
+                    presenter?.onViewPaused(this@LocalSearchedVideosFragment) ?: Unit
 
             override fun onStop(owner: LifecycleOwner) =
-                    presenter.onViewStopped(this@LocalSearchedVideosFragment)
+                    presenter?.onViewStopped(this@LocalSearchedVideosFragment) ?: Unit
         })
     }
 
@@ -130,6 +132,7 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
         super.onAttach(context)
 
         val parent = parentFragment
+        presenter = Presenter.Provider(this).get(ILocalSearchedVideosPresenter.getImplClass())
 
         mInteractionCallback = when {
             parent is InteractionCallback -> parent
@@ -147,7 +150,7 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
         }
         mLifecycleCallback?.onFragmentAttached(this)
 
-        presenter.attachToView(this)
+        presenter?.attachToView(this)
     }
 
     override fun onScreenWidthDpLevelChanged(
@@ -185,7 +188,7 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
 
                 override fun onQueryTextChange(newText: String): Boolean {
                     mSearchText = newText.trim()
-                    presenter.refreshList(mSearchText)
+                    presenter?.refreshList(mSearchText)
                     return true
                 }
             })
@@ -268,7 +271,7 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
                     SORT_MODE_RELEVANCY_DESC -> SORT_MODE_RELEVANCY_ASC
                     else -> SORT_MODE_RELEVANCY_DESC
                 }
-                presenter.sortList(sortMode)
+                presenter?.sortList(sortMode)
             }
             R.id.btn_sortByName -> {
                 val sortMode = when (mSortByNameBtn.tag) {
@@ -276,7 +279,7 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
                     SORT_MODE_NAME_DESC -> SORT_MODE_NAME_ASC
                     else -> SORT_MODE_NAME_ASC
                 }
-                presenter.sortList(sortMode)
+                presenter?.sortList(sortMode)
             }
             R.id.btn_sortByDate -> {
                 val sortMode = when (mSortByDateBtn.tag) {
@@ -284,7 +287,7 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
                     SORT_MODE_DATE_DESC -> SORT_MODE_DATE_ASC
                     else -> SORT_MODE_DATE_ASC
                 }
-                presenter.sortList(sortMode)
+                presenter?.sortList(sortMode)
             }
             R.id.btn_sortBySize -> {
                 val sortMode = when (mSortBySizeBtn.tag) {
@@ -292,19 +295,19 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
                     SORT_MODE_SIZE_DESC -> SORT_MODE_SIZE_ASC
                     else -> SORT_MODE_SIZE_ASC
                 }
-                presenter.sortList(sortMode)
+                presenter?.sortList(sortMode)
             }
         }
 
         if (v.parent === mRecyclerView) {
-            presenter.playVideoAt(v.tag as Int)
+            presenter?.playVideoAt(v.tag as Int)
         }
     }
 
     override fun onLongClick(v: View) =
             if (v.parent === mRecyclerView) {
                 val index = v.tag as Int
-                presenter.showVideoOptionsMenu(index) { video ->
+                presenter?.showVideoOptionsMenu(index) { video ->
                     val headersCount = mAdapterWrapper.headersCount
                     val position = headersCount + index
                     val videoWritable = video.isWritable
@@ -317,11 +320,11 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
                     mVideoOptionsMenu!!.setItemEnabled(R.id.rename, videoWritable)
                     mVideoOptionsMenu!!.setOnItemClickListener { menuItem, _ ->
                         when (menuItem.iconResId) {
-                            R.drawable.ic_file_move_menu -> presenter.moveVideoAt(index)
-                            R.drawable.ic_delete_24dp_menu -> presenter.deleteVideoAt(index)
-                            R.drawable.ic_edit_24dp_menu -> presenter.renameVideoAt(index)
-                            R.drawable.ic_share_24dp_menu -> presenter.shareVideoAt(index)
-                            R.drawable.ic_info_24dp_menu -> presenter.viewDetailsOfVideoAt(index)
+                            R.drawable.ic_file_move_menu -> presenter?.moveVideoAt(index)
+                            R.drawable.ic_delete_24dp_menu -> presenter?.deleteVideoAt(index)
+                            R.drawable.ic_edit_24dp_menu -> presenter?.renameVideoAt(index)
+                            R.drawable.ic_share_24dp_menu -> presenter?.shareVideoAt(index)
+                            R.drawable.ic_info_24dp_menu -> presenter?.viewDetailsOfVideoAt(index)
                         }
                     }
                     mVideoOptionsMenu!!.setOnDismissListener {
@@ -343,7 +346,7 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
     override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
         super.onViewCreated(view, savedInstanceState)
         mLifecycleCallback?.onFragmentViewCreated(this)
-        presenter.onViewCreated(this)
+        presenter?.onViewCreated(this)
     }
 
     override fun onDestroyView() {
@@ -353,12 +356,15 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
         mSelectedItemIndex = NO_POSITION
         mVideoOptionsMenu?.dismiss()
 
-        if (mSearchText != EMPTY_STRING) {
-            mSearchText = EMPTY_STRING
-            presenter.refreshList(EMPTY_STRING)
+        val presenter = presenter
+        if (presenter != null) {
+            if (mSearchText != EMPTY_STRING) {
+                mSearchText = EMPTY_STRING
+                presenter.refreshList(EMPTY_STRING)
+            }
+            presenter.stopLoadVideos()
+            presenter.onViewDestroyed(this)
         }
-        presenter.stopLoadVideos()
-        presenter.onViewDestroyed(this)
 
         mInteractionCallback.setOnRefreshLayoutChildScrollUpCallback(null)
     }
@@ -366,7 +372,7 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
     override fun onDetach() {
         super.onDetach()
         mLifecycleCallback?.onFragmentDetached(this)
-        presenter.detachFromView(this)
+        presenter?.detachFromView(this)
     }
 
     override fun onReturnResult(resultCode: Int, data: Intent?) {
@@ -375,7 +381,7 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
 
     override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
         super.onActivityResult(requestCode, resultCode, data)
-        presenter.onActivityResult(requestCode, resultCode, data)
+        presenter?.onActivityResult(requestCode, resultCode, data)
     }
 
     override fun updateListVisibilityAndSearchResultText() {
@@ -466,7 +472,9 @@ class LocalSearchedVideosFragment : BaseFragment(), ILocalSearchedVideosView, Vi
         }
     }
 
-    override fun onRefresh() = presenter.startLoadVideos()
+    override fun onRefresh() {
+        presenter?.startLoadVideos()
+    }
 
     override fun onVideosLoadStart() {
         mVideoOptionsMenu?.dismiss()
diff --git a/app/src/main/java/com/liuzhenlin/videos/view/fragment/LocalVideoListFragment.kt b/app/src/main/java/com/liuzhenlin/videos/view/fragment/LocalVideoListFragment.kt
index 12606a5..6882054 100644
--- a/app/src/main/java/com/liuzhenlin/videos/view/fragment/LocalVideoListFragment.kt
+++ b/app/src/main/java/com/liuzhenlin/videos/view/fragment/LocalVideoListFragment.kt
@@ -55,6 +55,7 @@ import com.liuzhenlin.videos.presenter.ILocalVideoListPresenter.VideoListAdapter
 import com.liuzhenlin.videos.presenter.ILocalVideoListPresenter.VideoListAdapter.Companion.PAYLOAD_REFRESH_VIDEODIR_THUMB
 import com.liuzhenlin.videos.presenter.ILocalVideoListPresenter.VideoListAdapter.Companion.VIEW_TYPE_VIDEO
 import com.liuzhenlin.videos.presenter.ILocalVideoListPresenter.VideoListAdapter.Companion.VIEW_TYPE_VIDEODIR
+import com.liuzhenlin.videos.presenter.Presenter
 import com.liuzhenlin.videos.utils.VideoUtils2
 import com.liuzhenlin.videos.view.IView
 import com.liuzhenlin.videos.view.fragment.Payloads.*
@@ -132,7 +133,8 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
     private var mShareButton_IOW: TextView? = null
     private var mDetailsButton_IOW: TextView? = null
 
-    internal val presenter = ILocalVideoListPresenter.newInstance()
+    internal var presenter: ILocalVideoListPresenter? = null
+        private set
 
     private var _TOP: String? = null
     private val TOP: String
@@ -180,6 +182,7 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
         super.onAttach(context)
 
         val parent = parentFragment
+        presenter = Presenter.Provider(this).get(ILocalVideoListPresenter.getImplClass())
 
         mInteractionCallback = when {
             parent is InteractionCallback -> parent
@@ -197,7 +200,7 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
         }
         mLifecycleCallback?.onFragmentAttached(this)
 
-        presenter.attachToView(this)
+        presenter?.attachToView(this)
     }
 
     override fun onCreateView(
@@ -256,42 +259,42 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
     override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
         super.onViewCreated(view, savedInstanceState)
         mLifecycleCallback?.onFragmentViewCreated(this)
-        presenter.onViewCreated(this)
+        presenter?.onViewCreated(this)
     }
 
     override fun onStart() {
         super.onStart()
-        presenter.onViewStart(this)
+        presenter?.onViewStart(this)
     }
 
     override fun onResume() {
         super.onResume()
-        presenter.onViewResume(this)
+        presenter?.onViewResume(this)
     }
 
     override fun onPause() {
         super.onPause()
-        presenter.onViewPaused(this)
+        presenter?.onViewPaused(this)
     }
 
     // This method can be called when a stopped activity is being recreated,
     // in which case onStop() is being called unexpectedly.
     override fun onStop() {
         super.onStop()
-        presenter.onViewStopped(this)
+        presenter?.onViewStopped(this)
     }
 
     override fun onDestroyView() {
         super.onDestroyView()
         mLifecycleCallback?.onFragmentViewDestroyed(this)
         dismissAllFloatingWindows()
-        presenter.onViewDestroyed(this)
+        presenter?.onViewDestroyed(this)
     }
 
     override fun onDetach() {
         super.onDetach()
         mLifecycleCallback?.onFragmentDetached(this)
-        presenter.detachFromView(this)
+        presenter?.detachFromView(this)
     }
 
     override fun onReturnResult(resultCode: Int, data: Intent?) {
@@ -309,7 +312,7 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
 
     override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
         super.onActivityResult(requestCode, resultCode, data)
-        presenter.onActivityResult(requestCode, resultCode, data)
+        presenter?.onActivityResult(requestCode, resultCode, data)
     }
 
     override fun goToLocalVideoSubListFragment(args: Bundle) =
@@ -318,7 +321,9 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
     override fun goToVideoMoveFragment(args: Bundle) =
             mInteractionCallback.goToVideoMoveFragment(args)
 
-    override fun onRefresh() = presenter.startLoadVideos()
+    override fun onRefresh() {
+        presenter?.startLoadVideos()
+    }
 
     override fun dismissItemOptionsWindow() {
         // 1）自动刷新时隐藏弹出的多选窗口
@@ -543,29 +548,29 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
                 val index = v.tag as Int
                 if (mItemOptionsWindow == null) {
                     when (mAdapterWrapper.innerAdapter.getItemViewType(index)) {
-                        VIEW_TYPE_VIDEO -> presenter.playVideoAt(index) // 播放视频
+                        VIEW_TYPE_VIDEO -> presenter?.playVideoAt(index) // 播放视频
                         VIEW_TYPE_VIDEODIR -> { // 显示指定目录的视频
-                            presenter.openVideoDirectoryAt(index)
+                            presenter?.openVideoDirectoryAt(index)
                         }
                     }
                 } else {
-                    presenter.toggleItemChecked(index)
+                    presenter?.toggleItemChecked(index)
                 }
             }
 
             R.id.checkbox -> {
                 val index = v.tag as Int
-                presenter.toggleItemChecked(index)
+                presenter?.toggleItemChecked(index)
             }
 
             // 置顶或取消置顶视频（目录）
             R.id.btn_top -> {
                 val index = v.tag as Int
-                presenter.toggleItemTopped(index)
+                presenter?.toggleItemTopped(index)
             }
 
             // 删除视频
-            R.id.btn_delete -> presenter.deleteItemAt(v.tag as Int, true)
+            R.id.btn_delete -> presenter?.deleteItemAt(v.tag as Int, true)
             R.id.btn_confirm_deleteVideoListItemDialog -> {
                 val window = mDeleteItemDialog!!.window!!
                 val decorView = window.decorView as ViewGroup
@@ -578,16 +583,16 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
                 if (onDeleteAction != null) {
                     onDeleteAction()
                 } else {
-                    presenter.deleteItem(item, false)
+                    presenter?.deleteItem(item, false)
                 }
             }
             R.id.btn_cancel_deleteVideoListItemDialog -> mDeleteItemDialog!!.cancel()
 
             // 移动（多个）视频
-            R.id.btn_move -> presenter.moveCheckedItems()
+            R.id.btn_move -> presenter?.moveCheckedItems()
 
             // 删除（多个）视频
-            R.id.btn_delete_vlow -> presenter.deleteCheckedItems(true)
+            R.id.btn_delete_vlow -> presenter?.deleteCheckedItems(true)
             R.id.btn_confirm_deleteItemsWindow -> {
                 val view = mDeleteItemsWindow!!.contentView as ViewGroup
                 @Suppress("UNCHECKED_CAST")
@@ -602,9 +607,9 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
                     onDeleteAction()
                 } else {
                     if (items.size == 1) {
-                        presenter.deleteItem(items[0], false)
+                        presenter?.deleteItem(items[0], false)
                     } else {
-                        presenter.deleteItems(*items, needUserConfirm = false)
+                        presenter?.deleteItems(*items, needUserConfirm = false)
                     }
                 }
             }
@@ -612,7 +617,7 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
 
             // 重命名视频或给视频目录取别名
             R.id.btn_rename -> {
-                presenter.renameCheckedItem()
+                presenter?.renameCheckedItem()
                 mItemOptionsWindow!!.dismiss()
             }
             R.id.btn_complete_renameVideoListItemDialog -> {
@@ -634,20 +639,20 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
                     onRenameAction(newName)
                 } else {
                     item.name = newName
-                    presenter.renameItemTo(item)
+                    presenter?.renameItemTo(item)
                 }
             }
             R.id.btn_cancel_renameVideoListItemDialog -> mRenameItemDialog!!.cancel()
 
             // 分享
             R.id.btn_share -> {
-                presenter.shareCheckedVideo()
+                presenter?.shareCheckedVideo()
                 mItemOptionsWindow!!.dismiss()
             }
 
             // 显示视频（目录）详情
             R.id.btn_details -> {
-                presenter.viewCheckedItemDetails()
+                presenter?.viewCheckedItemDetails()
                 mItemOptionsWindow!!.dismiss()
             }
             R.id.btn_ok_videoListItemDetailsDialog -> mItemDetailsDialog!!.cancel()
@@ -657,10 +662,10 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
             R.id.btn_selectAll -> {
                 // 全选
                 if (SELECT_ALL == mSelectAllButton!!.text.toString()) {
-                    presenter.selectAllItems()
+                    presenter?.selectAllItems()
                     // 全不选
                 } else {
-                    presenter.unselectAllItems()
+                    presenter?.unselectAllItems()
                 }
             }
 
@@ -670,7 +675,7 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
                     SORT_MODE_NAME_DESC -> SORT_MODE_NAME_ASC
                     else -> SORT_MODE_NAME_ASC
                 }
-                presenter.reorderAllItems(sortMode)
+                presenter?.reorderAllItems(sortMode)
             }
             R.id.btn_sortByDate -> {
                 val sortMode = when (mSortByDateBtn.tag) {
@@ -678,7 +683,7 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
                     SORT_MODE_DATE_DESC -> SORT_MODE_DATE_ASC
                     else -> SORT_MODE_DATE_ASC
                 }
-                presenter.reorderAllItems(sortMode)
+                presenter?.reorderAllItems(sortMode)
             }
             R.id.btn_sortBySize -> {
                 val sortMode = when (mSortBySizeBtn.tag) {
@@ -686,7 +691,7 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
                     SORT_MODE_SIZE_DESC -> SORT_MODE_SIZE_ASC
                     else -> SORT_MODE_SIZE_ASC
                 }
-                presenter.reorderAllItems(sortMode)
+                presenter?.reorderAllItems(sortMode)
             }
         }
     }
@@ -804,7 +809,7 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
                         notifyItemRangeChanged(position + 1, itemCount - position - 1,
                                 PAYLOAD_CHANGE_CHECKBOX_VISIBILITY or PAYLOAD_REFRESH_CHECKBOX)
                         // 勾选当前长按的itemView
-                        presenter.setItemChecked(itemIndex, true)
+                        presenter?.setItemChecked(itemIndex, true)
                         notifyItemChanged(position,
                                 PAYLOAD_CHANGE_CHECKBOX_VISIBILITY
                                         or PAYLOAD_REFRESH_CHECKBOX_WITH_ANIMATOR)
@@ -827,7 +832,7 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
 
                     val headersCount = mAdapterWrapper.headersCount
                     for (index in 0 until mAdapterWrapper.itemCount - headersCount) {
-                        presenter.setItemChecked(index, false)
+                        presenter?.setItemChecked(index, false)
                     }
                     mAdapterWrapper.notifyItemRangeChanged(
                             headersCount, mAdapterWrapper.itemCount - headersCount,
@@ -1216,7 +1221,9 @@ class LocalVideoListFragment : BaseFragment(), ILocalVideoListView,
         }
     }
 
-    override fun showVideosMovePage(vararg items: VideoListItem) = presenter.moveItems(*items)
+    override fun showVideosMovePage(vararg items: VideoListItem) {
+        presenter?.moveItems(*items)
+    }
 
     override fun onItemsDeleteStart(vararg items: VideoListItem) {
         if (mItemsDeletingDialog == null) {
diff --git a/app/src/main/java/com/liuzhenlin/videos/view/fragment/LocalVideosFragment.kt b/app/src/main/java/com/liuzhenlin/videos/view/fragment/LocalVideosFragment.kt
index c836fc6..d3d6414 100644
--- a/app/src/main/java/com/liuzhenlin/videos/view/fragment/LocalVideosFragment.kt
+++ b/app/src/main/java/com/liuzhenlin/videos/view/fragment/LocalVideosFragment.kt
@@ -117,17 +117,18 @@ class LocalVideosFragment : Fragment(), ILocalVideosFragment, FragmentPartLifecy
 
                 val sublistFragmentIndex = mLocalVideoSubListFragments?.indexOf(childFragment) ?: -1
                 if (sublistFragmentIndex >= 0) {
-                    mLocalVideoListFragment.presenter
-                            .addOnVideoItemsLoadListener(childFragment.presenter)
-                    if (childFragment.presenter is LocalVideoListPresenter) {
-                        val lastFragment =
-                                if (sublistFragmentIndex > 0)
-                                    mLocalVideoSubListFragments!![sublistFragmentIndex - 1]
-                                else
-                                    mLocalVideoListFragment
-                        val parentPresenter = lastFragment.presenter
-                        if (parentPresenter is LocalVideoListPresenter)
-                            childFragment.presenter.setParentPresenter(parentPresenter)
+                    childFragment.presenter?.let {
+                        mLocalVideoListFragment.presenter?.addOnVideoItemsLoadListener(it)
+                        if (it is LocalVideoListPresenter) {
+                            val lastFragment =
+                                    if (sublistFragmentIndex > 0)
+                                        mLocalVideoSubListFragments!![sublistFragmentIndex - 1]
+                                    else
+                                        mLocalVideoListFragment
+                            val parentPresenter = lastFragment.presenter
+                            if (parentPresenter is LocalVideoListPresenter)
+                                it.setParentPresenter(parentPresenter)
+                        }
                     }
 
                     mInteractionCallback.setSideDrawerEnabled(false)
@@ -139,7 +140,9 @@ class LocalVideosFragment : Fragment(), ILocalVideosFragment, FragmentPartLifecy
 
             childFragment === mLocalSearchedVideosFragment -> {
                 childFragment.setVideoOpCallback(mLocalVideoListFragment)
-                mLocalVideoListFragment.presenter.addOnVideoItemsLoadListener(childFragment.presenter)
+                childFragment.presenter?.let {
+                    mLocalVideoListFragment.presenter?.addOnVideoItemsLoadListener(it)
+                }
                 mSwipeRefreshLayout.setOnRefreshListener(childFragment)
 
                 mInteractionCallback.setSideDrawerEnabled(false)
@@ -163,8 +166,9 @@ class LocalVideosFragment : Fragment(), ILocalVideosFragment, FragmentPartLifecy
                 val sublistFragmentIndex = mLocalVideoSubListFragments?.indexOf(childFragment) ?: -1
                 if (sublistFragmentIndex >= 0) {
                     mLocalVideoSubListFragments!!.removeAt(sublistFragmentIndex)
-                    mLocalVideoListFragment.presenter
-                            .removeOnVideoItemsLoadListener(childFragment.presenter)
+                    childFragment.presenter?.let {
+                        mLocalVideoListFragment.presenter?.removeOnVideoItemsLoadListener(it)
+                    }
                     if (sublistFragmentIndex == 0) {
                         mSwipeRefreshLayout.setOnRefreshListener(mLocalVideoListFragment)
 
@@ -178,8 +182,9 @@ class LocalVideosFragment : Fragment(), ILocalVideosFragment, FragmentPartLifecy
                 }
             }
             childFragment === mLocalSearchedVideosFragment -> {
-                mLocalVideoListFragment.presenter
-                        .removeOnVideoItemsLoadListener(childFragment.presenter)
+                childFragment.presenter?.let {
+                    mLocalVideoListFragment.presenter?.removeOnVideoItemsLoadListener(it)
+                }
                 mLocalSearchedVideosFragment = null
                 mSwipeRefreshLayout.setOnRefreshListener(mLocalVideoListFragment)
 
@@ -216,7 +221,7 @@ class LocalVideosFragment : Fragment(), ILocalVideosFragment, FragmentPartLifecy
 
     override fun goToLocalSearchedVideosFragment() {
         mLocalSearchedVideosFragment = LocalSearchedVideosFragment()
-        mLocalVideoListFragment.presenter.setArgsForLocalSearchedVideosFragment(
+        mLocalVideoListFragment.presenter?.setArgsForLocalSearchedVideosFragment(
                 mLocalSearchedVideosFragment!!)
         mLocalSearchedVideosFragment!!.setTargetFragment(
                 mLocalVideoListFragment, REQUEST_CODE_LOCAL_SEARCHED_VIDEOS_FRAGMENT)
diff --git a/app/src/main/java/com/liuzhenlin/videos/view/fragment/VideoMoveFragment.kt b/app/src/main/java/com/liuzhenlin/videos/view/fragment/VideoMoveFragment.kt
index e8593f3..5bb6acf 100644
--- a/app/src/main/java/com/liuzhenlin/videos/view/fragment/VideoMoveFragment.kt
+++ b/app/src/main/java/com/liuzhenlin/videos/view/fragment/VideoMoveFragment.kt
@@ -35,6 +35,7 @@ import com.liuzhenlin.videos.bean.Video
 import com.liuzhenlin.videos.bean.VideoDirectory
 import com.liuzhenlin.videos.contextThemedFirst
 import com.liuzhenlin.videos.presenter.IVideoMovePresenter
+import com.liuzhenlin.videos.presenter.Presenter
 import com.liuzhenlin.videos.utils.VideoUtils2
 import com.liuzhenlin.videos.videoCount
 import com.liuzhenlin.videos.view.IView
@@ -74,32 +75,33 @@ class VideoMoveFragment : FullscreenDialogFragment<IVideoMovePresenter>(R.layout
 
     private var mVideoMovingDialog: Dialog? = null
 
-    private val mPresenter = IVideoMovePresenter.newInstance()
+    private var mPresenter: IVideoMovePresenter? = null
 
     init {
         lifecycle.addObserver(object : DefaultLifecycleObserver {
             override fun onStart(owner: LifecycleOwner) =
-                    mPresenter.onViewStart(this@VideoMoveFragment)
+                    mPresenter?.onViewStart(this@VideoMoveFragment) ?: Unit
 
             override fun onResume(owner: LifecycleOwner) =
-                    mPresenter.onViewResume(this@VideoMoveFragment)
+                    mPresenter?.onViewResume(this@VideoMoveFragment) ?: Unit
 
             override fun onPause(owner: LifecycleOwner) =
-                    mPresenter.onViewPaused(this@VideoMoveFragment)
+                    mPresenter?.onViewPaused(this@VideoMoveFragment) ?: Unit
 
             override fun onStop(owner: LifecycleOwner) =
-                    mPresenter.onViewStopped(this@VideoMoveFragment)
+                    mPresenter?.onViewStopped(this@VideoMoveFragment) ?: Unit
         })
     }
 
     override fun onAttach(context: Context) {
         super.onAttach(context)
-        mPresenter.attachToView(this)
+        mPresenter = Presenter.Provider(this).get(IVideoMovePresenter.getImplClass())
+        mPresenter?.attachToView(this)
     }
 
     override fun onDetach() {
         super.onDetach()
-        mPresenter.detachFromView(this)
+        mPresenter?.detachFromView(this)
     }
 
     override fun onScreenWidthDpLevelChanged(
@@ -110,7 +112,7 @@ class VideoMoveFragment : FullscreenDialogFragment<IVideoMovePresenter>(R.layout
 
     override fun onDialogCreated(dialog: Dialog) {
         super.onDialogCreated(dialog)
-        mPresenter.onViewCreated(this)
+        mPresenter?.onViewCreated(this)
     }
 
     override fun init(adapter: TargetDirListAdapter, videoQuantity: Int) {
@@ -137,18 +139,18 @@ class VideoMoveFragment : FullscreenDialogFragment<IVideoMovePresenter>(R.layout
 
     override fun onRestoreInstanceState(savedInstanceState: Bundle?) {
         super.onRestoreInstanceState(savedInstanceState)
-        mPresenter.restoreInstanceState(savedInstanceState)
+        mPresenter?.restoreInstanceState(savedInstanceState)
     }
 
     override fun onSaveInstanceState(outState: Bundle) {
         super.onSaveInstanceState(outState)
-        mPresenter.saveInstanceState(outState)
+        mPresenter?.saveInstanceState(outState)
     }
 
     override fun onDismiss(dialog: DialogInterface) {
         super.onDismiss(dialog)
         mVideoMovingDialog?.dismiss()
-        mPresenter.onViewDestroyed(this)
+        mPresenter?.onViewDestroyed(this)
         mVideoDirList = null
         mTitleText = null
         mOkayButton = null
@@ -156,7 +158,7 @@ class VideoMoveFragment : FullscreenDialogFragment<IVideoMovePresenter>(R.layout
 
     override fun onClick(v: View) {
         when (v.id) {
-            R.id.btn_ok -> mPresenter.moveVideosToCheckedDir()
+            R.id.btn_ok -> mPresenter?.moveVideosToCheckedDir()
             R.id.btn_cancel -> dismiss()
 
             R.id.btn_ok_vmpd -> {
@@ -164,7 +166,7 @@ class VideoMoveFragment : FullscreenDialogFragment<IVideoMovePresenter>(R.layout
                 val checkbox = promptDialog.findViewById<CheckBox>(R.id.checkbox)
                 val neverPromptAgain = checkbox!!.isChecked
                 promptDialog.cancel()
-                mPresenter.onVideoMovePromptConfirmed(neverPromptAgain)
+                mPresenter?.onVideoMovePromptConfirmed(neverPromptAgain)
             }
             R.id.btn_cancel_vmpd -> {
                 val promptDialog = v.tag as AppCompatDialog
@@ -279,7 +281,7 @@ class VideoMoveFragment : FullscreenDialogFragment<IVideoMovePresenter>(R.layout
 
         override fun onClick(v: View) {
             val position = v.tag as Int
-            mPresenter.toggleTargetDirChecked(position)
+            mPresenter?.toggleTargetDirChecked(position)
         }
     }
 }
\ No newline at end of file
diff --git a/common_build.gradle b/common_build.gradle
index b3351c8..c51c544 100644
--- a/common_build.gradle
+++ b/common_build.gradle
@@ -8,6 +8,7 @@ final boolean appModule = plugins.hasPlugin('com.android.application')
 if (appModule) {
     apply plugin: 'com.guardsquare.proguard'
 }
+apply plugin: 'kotlin-android'
 
 android {
     compileSdkVersion rootProject.ext.compileSdkVersion
@@ -42,6 +43,7 @@ if (appModule) {
 
 dependencies {
     implementation fileTree(dir: 'libs', include: ['*.jar'])
+    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8:$kotlin_version"
     implementation "androidx.appcompat:appcompat:$rootProject.ext.appcompatVersion"
 
     testImplementation "junit:junit:$rootProject.ext.testJunitVersion"
diff --git a/libraries/common/src/main/java/androidx/lifecycle/LifecycleCoroutineScopeImplAccessor.java b/libraries/common/src/main/java/androidx/lifecycle/LifecycleCoroutineScopeImplAccessor.java
new file mode 100644
index 0000000..2856273
--- /dev/null
+++ b/libraries/common/src/main/java/androidx/lifecycle/LifecycleCoroutineScopeImplAccessor.java
@@ -0,0 +1,24 @@
+/*
+ * Created on 2025-1-6 9:15:21 PM.
+ * Copyright © 2025 刘振林. All rights reserved.
+ */
+
+package androidx.lifecycle;
+
+import androidx.annotation.NonNull;
+
+import kotlin.coroutines.CoroutineContext;
+
+/** @noinspection KotlinInternalInJava*/
+public class LifecycleCoroutineScopeImplAccessor {
+
+    @NonNull
+    public static LifecycleCoroutineScopeImpl newLifecycleCoroutineScopeImpl(
+            @NonNull Lifecycle lifecycle, @NonNull CoroutineContext coroutineContext) {
+        return new LifecycleCoroutineScopeImpl(lifecycle, coroutineContext);
+    }
+
+    public static void register(@NonNull LifecycleCoroutineScopeImpl impl) {
+        impl.register();
+    }
+}
diff --git a/libraries/common/src/main/java/androidx/lifecycle/ViewModelAccessor.java b/libraries/common/src/main/java/androidx/lifecycle/ViewModelAccessor.java
new file mode 100644
index 0000000..f8b2f22
--- /dev/null
+++ b/libraries/common/src/main/java/androidx/lifecycle/ViewModelAccessor.java
@@ -0,0 +1,25 @@
+/*
+ * Created on 2025-1-6 8:52:55 PM.
+ * Copyright © 2025 刘振林. All rights reserved.
+ */
+
+package androidx.lifecycle;
+
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+
+public class ViewModelAccessor {
+    private ViewModelAccessor() {
+    }
+
+    @Nullable
+    public static <T> T getTag(@NonNull ViewModel viewModel, @NonNull String key) {
+        return viewModel.getTag(key);
+    }
+
+    @NonNull
+    public static <T> T setTagIfAbsent(
+            @NonNull ViewModel viewModel, @NonNull String key, @NonNull T newValue) {
+        return viewModel.setTagIfAbsent(key, newValue);
+    }
+}
diff --git a/libraries/common/src/main/java/com/liuzhenlin/common/utils/CloseableCoroutineScope.kt b/libraries/common/src/main/java/com/liuzhenlin/common/utils/CloseableCoroutineScope.kt
new file mode 100644
index 0000000..f44e557
--- /dev/null
+++ b/libraries/common/src/main/java/com/liuzhenlin/common/utils/CloseableCoroutineScope.kt
@@ -0,0 +1,20 @@
+/*
+ * Created on 2025-1-6 9:04:11 PM.
+ * Copyright © 2025 刘振林. All rights reserved.
+ */
+
+package com.liuzhenlin.common.utils
+
+import kotlinx.coroutines.CoroutineScope
+import kotlinx.coroutines.cancel
+import java.io.Closeable
+import kotlin.coroutines.CoroutineContext
+
+class CloseableCoroutineScope(context: CoroutineContext) : Closeable, CoroutineScope {
+
+    override val coroutineContext: CoroutineContext = context
+
+    override fun close() {
+        coroutineContext.cancel()
+    }
+}
\ No newline at end of file
diff --git a/libraries/common/src/main/java/com/liuzhenlin/common/utils/Coroutines.kt b/libraries/common/src/main/java/com/liuzhenlin/common/utils/Coroutines.kt
new file mode 100644
index 0000000..fff82ed
--- /dev/null
+++ b/libraries/common/src/main/java/com/liuzhenlin/common/utils/Coroutines.kt
@@ -0,0 +1,78 @@
+/*
+ * Created on 2025-1-6 9:56:52 PM.
+ * Copyright © 2025 刘振林. All rights reserved.
+ */
+@file:JvmName("Coroutines")
+
+package com.liuzhenlin.common.utils
+
+import android.annotation.SuppressLint
+import android.util.Log
+import androidx.lifecycle.Lifecycle
+import androidx.lifecycle.LifecycleCoroutineScope
+import androidx.lifecycle.LifecycleCoroutineScopeImplAccessor
+import androidx.lifecycle.LifecycleOwner
+import androidx.lifecycle.ViewModel
+import androidx.lifecycle.ViewModelAccessor
+
+import kotlinx.coroutines.CoroutineDispatcher
+import kotlinx.coroutines.CoroutineExceptionHandler
+import kotlinx.coroutines.CoroutineName
+import kotlinx.coroutines.CoroutineScope
+import kotlinx.coroutines.Dispatchers
+import kotlinx.coroutines.SupervisorJob
+import kotlinx.coroutines.asCoroutineDispatcher
+import kotlin.coroutines.CoroutineContext
+
+private const val TAG = "Coroutines"
+
+private const val JOB_KEY = "com.liuzhenlin.common.utils.Coroutines.viewModelScope"
+
+object AppScope : CoroutineScope {
+    override val coroutineContext: CoroutineContext =
+            newCoroutineContext("AppScope", Dispatchers.CPU)
+}
+
+public val ViewModel.viewModelScope: CoroutineScope
+    get() {
+        val scope: CoroutineScope? = ViewModelAccessor.getTag(this, JOB_KEY)
+        if (scope != null) {
+            return scope
+        }
+        return ViewModelAccessor.setTagIfAbsent(this, JOB_KEY,
+                CloseableCoroutineScope(
+                        newCoroutineContext("ViewModelScope", Dispatchers.Main.immediate)))
+    }
+
+public inline val LifecycleOwner.lifecycleScope: LifecycleCoroutineScope
+    get() = lifecycle.lifecycleScope
+
+public val Lifecycle.lifecycleScope: LifecycleCoroutineScope
+    @SuppressLint("RestrictedApi")
+    get() {
+        while (true) {
+            val existing = internalScopeRef.get() as LifecycleCoroutineScope?
+            if (existing != null) {
+                return existing
+            }
+            val newScope =
+                    LifecycleCoroutineScopeImplAccessor.newLifecycleCoroutineScopeImpl(
+                            this, newCoroutineContext("LifecycleScope", Dispatchers.Main.immediate))
+            if (internalScopeRef.compareAndSet(null, newScope)) {
+                LifecycleCoroutineScopeImplAccessor.register(newScope)
+                return newScope
+            }
+        }
+    }
+
+private fun newCoroutineContext(name: String, dispatcher: CoroutineDispatcher): CoroutineContext {
+    return CoroutineName(name) + SupervisorJob() + dispatcher + sExceptionHandler
+}
+
+private val sExceptionHandler = CoroutineExceptionHandler { coroutineScope, throwable ->
+    Log.w(TAG, coroutineScope[CoroutineName.Key]?.name, throwable)
+}
+
+public inline val Dispatchers.CPU get() = Dispatchers.Default
+
+public val Dispatchers.Single by lazy { Executors.SERIAL_EXECUTOR.asCoroutineDispatcher() }
\ No newline at end of file
diff --git a/libraries/common/src/main/java/com/liuzhenlin/common/utils/JCoroutine.java b/libraries/common/src/main/java/com/liuzhenlin/common/utils/JCoroutine.java
new file mode 100644
index 0000000..3fb3f05
--- /dev/null
+++ b/libraries/common/src/main/java/com/liuzhenlin/common/utils/JCoroutine.java
@@ -0,0 +1,127 @@
+/*
+ * Created on 2025-1-4 7:31:41 PM.
+ * Copyright © 2025 刘振林. All rights reserved.
+ */
+
+package com.liuzhenlin.common.utils;
+
+import android.util.Log;
+
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+import androidx.core.util.Consumer;
+import androidx.core.util.Supplier;
+
+import kotlin.coroutines.Continuation;
+import kotlin.coroutines.CoroutineContext;
+import kotlin.coroutines.EmptyCoroutineContext;
+import kotlinx.coroutines.BuildersKt;
+import kotlinx.coroutines.CoroutineDispatcher;
+import kotlinx.coroutines.CoroutineScope;
+import kotlinx.coroutines.CoroutineStart;
+import kotlinx.coroutines.Deferred;
+import kotlinx.coroutines.Dispatchers;
+import kotlinx.coroutines.Job;
+
+@JavaOnly
+@NonNullApi
+public class JCoroutine {
+
+    private static final String TAG = "JCoroutine";
+
+    public static final CoroutineDispatcher CpuDispatcher =
+            Coroutines.getCPU(Dispatchers.INSTANCE);
+    public static final CoroutineDispatcher SingleDispatcher =
+            Coroutines.getSingle(Dispatchers.INSTANCE);
+
+    private static final Continuation<?> EmptyContinuation =
+            createContinuation(EmptyCoroutineContext.INSTANCE, null);
+
+    public static <T> Continuation<T> emptyContinuation() {
+        //noinspection unchecked
+        return (Continuation<T>) EmptyContinuation;
+    }
+
+    public static <T> Continuation<T> createContinuation(
+            CoroutineContext context, @Nullable Consumer<T> resumeWith) {
+        return new Continuation<T>() {
+            @NonNull
+            @Override
+            public CoroutineContext getContext() {
+                return context;
+            }
+
+            @Override
+            public void resumeWith(Object o) {
+                if (resumeWith != null) {
+                    withContext(getContext().get(CoroutineDispatcher.Key), () -> {
+                        //noinspection unchecked
+                        resumeWith.accept((T) o);
+                    });
+                }
+            }
+        };
+    }
+
+    public static Job launch(CoroutineScope scope, Runnable block) {
+        return launch(scope, EmptyCoroutineContext.INSTANCE, block);
+    }
+
+    public static Job launch(
+            CoroutineScope scope, CoroutineContext context, Runnable block) {
+        return launch(scope, context, CoroutineStart.DEFAULT, block);
+    }
+
+    public static Job launch(
+            CoroutineScope scope, CoroutineContext context, CoroutineStart start, Runnable block) {
+        return BuildersKt.launch(scope, context, start, (coroutineScope, continuation) -> {
+            block.run();
+            return null;
+        });
+    }
+
+    public static <T> Deferred<T> async(CoroutineScope scope, Supplier<T> block) {
+        return async(scope, EmptyCoroutineContext.INSTANCE, block);
+    }
+
+    public static <T> Deferred<T> async(
+            CoroutineScope scope, CoroutineContext context, Supplier<T> block) {
+        return async(scope, context, CoroutineStart.DEFAULT, block);
+    }
+
+    public static <T> Deferred<T> async(
+            CoroutineScope scope, CoroutineContext context, CoroutineStart start, Supplier<T> block) {
+        return BuildersKt.async(
+                scope, context, start, (coroutineScope, continuation) -> block.get());
+    }
+
+    public static void withContext(CoroutineContext context, Runnable block) {
+        Supplier<Void> supplier = () -> {
+            block.run();
+            //noinspection DataFlowIssue
+            return null;
+        };
+        withContext(context, supplier, emptyContinuation());
+    }
+
+    public static <T> void withContext(
+            CoroutineContext context, Supplier<T> block, Continuation<T> complemention) {
+        Supplier<Void> supplier = () -> {
+            BuildersKt.withContext(
+                    context, (coroutineScope, continuation) -> block.get(), complemention);
+            //noinspection DataFlowIssue
+            return null;
+        };
+        try {
+            runBlocking(context, supplier);
+        } catch (InterruptedException e) {
+            // Job was canceled...
+            Log.w(TAG, e);
+        }
+    }
+
+    public static <T> T runBlocking(CoroutineContext context, Supplier<T> block)
+            throws InterruptedException {
+        return BuildersKt.runBlocking(context, ((coroutineScope, continuation) -> block.get()));
+    }
+}
diff --git a/libraries/common/src/main/java/com/liuzhenlin/common/utils/JavaOnly.java b/libraries/common/src/main/java/com/liuzhenlin/common/utils/JavaOnly.java
new file mode 100644
index 0000000..7ab640f
--- /dev/null
+++ b/libraries/common/src/main/java/com/liuzhenlin/common/utils/JavaOnly.java
@@ -0,0 +1,22 @@
+/*
+ * Created on 2025-1-6 5:27:05 AM.
+ * Copyright © 2025 刘振林. All rights reserved.
+ */
+
+package com.liuzhenlin.common.utils;
+
+import java.lang.annotation.Documented;
+import java.lang.annotation.ElementType;
+import java.lang.annotation.Retention;
+import java.lang.annotation.RetentionPolicy;
+import java.lang.annotation.Target;
+
+/**
+ * Specifies that this class, function, field, etc. is only designed for Java. Other Interoperable
+ * programming language like Kotlin should not access.
+ */
+@Documented
+@Retention(RetentionPolicy.CLASS)
+@Target({ElementType.FIELD, ElementType.METHOD, ElementType.TYPE})
+public @interface JavaOnly {
+}
diff --git a/libraries/common/src/main/java/com/liuzhenlin/common/utils/ReflectionUtils.java b/libraries/common/src/main/java/com/liuzhenlin/common/utils/ReflectionUtils.java
index 194b83c..5a9c3fd 100644
--- a/libraries/common/src/main/java/com/liuzhenlin/common/utils/ReflectionUtils.java
+++ b/libraries/common/src/main/java/com/liuzhenlin/common/utils/ReflectionUtils.java
@@ -8,6 +8,7 @@ package com.liuzhenlin.common.utils;
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
 
+import java.lang.reflect.Constructor;
 import java.lang.reflect.Field;
 import java.lang.reflect.Method;
 import java.lang.reflect.Modifier;
@@ -93,6 +94,19 @@ public class ReflectionUtils {
         return null;
     }
 
+    @Nullable
+    public static <T> Constructor<T> getDeclaredConstructor(
+            @NonNull Class<T> clazz, @Nullable Class<?>... parameterTypes) {
+        try {
+            Constructor<T> constructor = clazz.getDeclaredConstructor(parameterTypes);
+            constructor.setAccessible(true);
+            return constructor;
+        } catch (NoSuchMethodException e) {
+            e.printStackTrace();
+        }
+        return null;
+    }
+
     @Nullable
     public static <T> T getDeclaredFieldValue(
             @NonNull Class<?> clazz, @Nullable Object obj, @NonNull String fieldName) {
-- 
2.47.0.windows.1

